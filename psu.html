<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Питание датчиков</title>
  <style>

    :root{
      --bg:#0b0f19;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent2:#62b3ff;
      --border:rgba(148,163,184,.18);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --pad:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    :root[data-theme="light"]{
        --bg:#f7f8fb;
        --card:#ffffff;
        --muted:#5b6474;
        --text:#0b1220;
        --border:rgba(15,23,42,.12);
        --shadow: 0 10px 24px rgba(2,6,23,.10);
        --accent:#16a34a;
        --accent2:#0b74ff;
      }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(98,179,255,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1120px; margin: 0 auto; padding: 22px 16px 44px; }
    header.top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap; margin-bottom: 14px;
    }
    .title{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(98,179,255,.25));
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    h1{ font-size: 18px; line-height: 1.2; margin:0; letter-spacing:.2px; }
    .subtitle{ margin:2px 0 0; color:var(--muted); font-size: 13px; }
    .grid{ display:grid; grid-template-columns: 280px 1fr; gap: 14px; }
    @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 14px var(--pad);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{ font-size: 14px; }
    .card-b{ padding: var(--pad); }
    .pill{
      font-size: 12px;
      color: var(--muted);
      border:1px solid var(--border);
      padding: 3px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .nav{ display:flex; flex-direction:column; gap:10px; }
    .nav a{ text-decoration:none; display:flex; align-items:center; justify-content:flex-start; gap:10px; font-weight:900; }
    .nav button, .nav a{
      width:100%;
      text-align:left;
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      display:flex; align-items:center; justify-content:flex-start; gap:10px;
      font-weight: 900;
    }
    .nav button:hover, .nav a:hover{ transform: translateY(-1px); }
    .nav a.active, .nav button.active{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }
    .nav .nav-title{ width:100%; display:block; font-size: 13px; line-height: 1.2; }
    .hint{ margin-top: 10px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 560px){ .row{ grid-template-columns: 1fr; } }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }
    .actions{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px; align-items:center; }
    .btn{
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 900;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(34,197,94,.55);
      background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(34,197,94,.10));
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .result{ margin-top: 14px; border-top:1px dashed var(--border); padding-top: 14px; display:grid; gap: 10px; }
    .kv{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
      padding: 10px 12px; border:1px solid var(--border); border-radius: 14px;
    }
    .kv span{ color: var(--muted); font-size: 12px; }
    .kv strong{ font-size: 15px; letter-spacing:.2px; }
    .kv.total{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(34,197,94,.06));
    }
    .kv.total span{ color: var(--text); font-weight: 900; }
    .kv.total strong{ font-size: 16px; }
    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(2,6,23,.85); color: #fff;
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: .18s ease;
      font-size: 13px;
      max-width: calc(100% - 24px);
      z-index: 9999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    /* ===== Mounting stepper ===== */
    #view-mount .m-stepper{ display:flex; flex-wrap:wrap; gap:8px; }
    #view-mount .m-step{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
    }
    #view-mount .m-step .n{
      width:22px;height:22px;border-radius:8px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    #view-mount .m-step.active{
      color:var(--text);
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.10);
    }
    #view-mount .m-step.active .n{
      color:var(--text);
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.18);
    }
    #view-mount .m-stepPane{ display:none; }
    #view-mount .m-stepPane.active{ display:block; }
    #view-mount .tiles{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    @media (max-width: 560px){ #view-mount .tiles{ grid-template-columns: 1fr; } }
    #view-mount .tile{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.02);
      transition: .15s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    #view-mount .tile:hover{ transform: translateY(-1px); }
    #view-mount .tile.active{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(34,197,94,.06));
    }
    #view-mount .switches{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ #view-mount .switches{ grid-template-columns: 1fr; } }
    #view-mount .tog{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:var(--text);
    }
    #view-mount .tog small{ color:var(--muted); font-weight:700; }
    #view-mount .tog input{ width:auto; }
    #view-mount .tog.disabled{ opacity:.65; cursor:not-allowed; }
    #view-mount .note{
      border:1px dashed rgba(98,179,255,.45);
      background: rgba(98,179,255,.08);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
      color:var(--text);
    }
    #view-mount .warn{
      border:1px dashed rgba(255,200,87,.55);
      background: rgba(255,200,87,.10);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
    }
    #view-mount .table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border); }
    #view-mount .table th,#view-mount .table td{ padding:10px 10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align: top; }
    #view-mount .table th{ text-align:left; color:var(--muted); font-weight:900; background: rgba(255,255,255,.04); }
    #view-mount .table tr:last-child td{ border-bottom:none; }

    /* ===== PSU scoped CSS ===== */
    #psuApp{
      --bg:#0b0d10; --text:#e9eef7; --muted:#9aa6bf;
      --border:rgba(255,255,255,.10); --shadow: 0 10px 30px rgba(0,0,0,.25);
      --accent:#62b3ff; --ok:#58d18b; --bad:#ff6b6b; --warn:#ffc857;
      --input:#0c1220; --ring: 0 0 0 3px rgba(98,179,255,.18);
      --card: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      --overlay: rgba(0,0,0,.55);

      
      --modal-bg: rgba(12, 16, 22, .90);
      --modal-bg-light: rgba(255,255,255,.90);
    }#psuApp[data-theme="light"]{
      --bg:#f6f7fb; --text:#172033; --muted:#5b6b86;
      --border:rgba(20,35,60,.12); --shadow: 0 10px 30px rgba(20,35,60,.10);
      --accent:#0b74ff; --ok:#1a9b52; --bad:#d63a3a; --warn:#b77800;
      --input:#f3f6ff; --ring: 0 0 0 3px rgba(11,116,255,.16);
      --card: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
      --overlay: rgba(10,20,40,.35);
    }#psuApp *{box-sizing:border-box}#psuApp{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(98,179,255,.10), transparent 60%),
                  radial-gradient(800px 500px at 90% 10%, rgba(88,209,139,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.35;
    }#psuApp .wrap{max-width:1180px;margin:0 auto;padding:22px 14px 60px}#psuApp header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--border); border-radius:18px; background:rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:50; backdrop-filter: blur(10px);
    }#psuApp header h1{font-size:18px;margin:0;font-weight:850;letter-spacing:.2px}#psuApp header .sub{font-size:12px;color:var(--muted); margin-top:4px}#psuApp .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}#psuApp .btn, #psuApp .chip{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }#psuApp .btn:hover{transform: translateY(-1px); border-color: rgba(98,179,255,.38)}#psuApp .btn:active{transform: translateY(0px)}#psuApp .btn.primary{
      border-color: rgba(98,179,255,.55);
      background: linear-gradient(180deg, rgba(98,179,255,.22), rgba(98,179,255,.10));
    }#psuApp .btn.ghost{background: transparent;}#psuApp .chip{display:flex; gap:8px; align-items:center; padding:8px 10px; font-weight:900;}#psuApp .dot{width:9px;height:9px;border-radius:999px;background:var(--accent)}#psuApp .dot.ok{background:var(--ok)}#psuApp .dot.bad{background:var(--bad)}#psuApp main{margin-top:16px;display:grid;grid-template-columns: 1fr; gap:14px}#psuApp .grid2{display:grid;grid-template-columns: 1.25fr .75fr; gap:14px}@media (max-width:980px){#psuApp .grid2{grid-template-columns:1fr}#psuApp header{position:relative; top:auto}}#psuApp .card{
      border:1px solid var(--border);
      border-radius:18px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding:14px;
    }#psuApp .card h2{margin:0 0 8px 0;font-size:14px;letter-spacing:.2px}#psuApp .muted{color:var(--muted)}#psuApp .row{display:flex; gap:12px; flex-wrap:wrap}#psuApp .field{flex:1; min-width:180px}#psuApp label{display:block;font-size:12px;color:var(--muted); margin:0 0 6px 0}#psuApp input, #psuApp select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--input);
      color: var(--text);
      outline:none;
      transition: box-shadow .2s ease, border-color .2s ease, opacity .2s ease;
      font-size:14px;
    }#psuApp input:focus, #psuApp select:focus{box-shadow: var(--ring); border-color: rgba(98,179,255,.55)}#psuApp input[disabled]{opacity:.55; cursor:not-allowed}#psuApp .help{font-size:12px;color:var(--muted); margin-top:6px}#psuApp .divider{height:1px;background:var(--border);margin:12px 0}#psuApp .stepper{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}#psuApp .step{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
    }#psuApp .step .n{
      width:22px;height:22px;border-radius:8px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      font-weight:950;
    }#psuApp .step.active{color:var(--text); border-color: rgba(98,179,255,.45); background: rgba(98,179,255,.10)}#psuApp .step.active .n{color:var(--text); border-color: rgba(98,179,255,.55); background: rgba(98,179,255,.18)}#psuApp .navrow{display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap}#psuApp .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }#psuApp .badge.ok{border-color: rgba(88,209,139,.45); background: rgba(88,209,139,.12); color: var(--ok)}#psuApp .badge.bad{border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.12); color: var(--bad)}#psuApp .badge.warn{border-color: rgba(255,200,87,.45); background: rgba(255,200,87,.12); color: var(--warn)}#psuApp .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
    }#psuApp .table th, #psuApp .table td{
      padding:10px 10px;
      border-bottom: 1px solid var(--border);
      font-size:13px;
      vertical-align: top;
    }#psuApp .table th{
      text-align:left;
      color: var(--muted);
      font-weight:950;
      background: rgba(255,255,255,.04);
    }#psuApp .table tr:last-child td{border-bottom:none}#psuApp .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}#psuApp .okbox{
      border:1px dashed rgba(88,209,139,.5);
      background: rgba(88,209,139,.08);
      padding:10px 12px; border-radius:14px;
      font-size:13px;
    }#psuApp .dangerbox{
      border:1px dashed rgba(255,107,107,.5);
      background: rgba(255,107,107,.08);
      padding:10px 12px; border-radius:14px;
      font-size:13px;
    }#psuApp .hintbox{
      border:1px dashed rgba(98,179,255,.45);
      background: rgba(98,179,255,.08);
      padding:10px 12px; border-radius:14px;
      font-size:13px;
    }#psuApp .viz{
      border:2px solid rgba(255,255,255,.22);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      height: 560px;
      position: relative;
      overflow: hidden;
    }#psuApp[data-theme="light"] .viz{
      border-color: rgba(20,35,60,.25);
      background: rgba(255,255,255,.65);
    }#psuApp .vizTitle{
      position:absolute; left:14px; top:12px;
      font-weight:950; font-size:28px; letter-spacing:.2px;
      color: rgba(255,255,255,.92);
      user-select:none;
      pointer-events:none;
    }#psuApp[data-theme="light"] .vizTitle{ color: rgba(20,35,60,.92); }#psuApp .vizSvg{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
    }#psuApp .nodeNum{ font-weight:950; font-size:28px; fill: #2f7fff; user-select:none; }#psuApp .nodeSourceHalo{ fill: rgba(88,209,139,.18); stroke: rgba(88,209,139,.6); stroke-width: 2; }#psuApp .edgeLine{ stroke: rgba(255,255,255,.75); stroke-width: 3; }#psuApp[data-theme="light"] .edgeLine{ stroke: rgba(20,35,60,.75); }#psuApp .edgeHit{ stroke: rgba(255,255,255,.01); stroke-width: 18; cursor:pointer; }#psuApp .edgeText{ font-weight:900; font-size:18px; fill: rgba(255,255,255,.92); user-select:none; }#psuApp[data-theme="light"] .edgeText{ fill: rgba(20,35,60,.92); }#psuApp .nodeHitCursor{ cursor: grab; }#psuApp .nodeHitCursor:active{ cursor: grabbing; }#psuApp .sensOuter{ fill: rgba(0, 182, 255, .06); stroke: #00b6ff; stroke-width: 4; }#psuApp .sensOuterSoft{ fill: transparent; stroke: rgba(0,182,255,.18); stroke-width: 10; }#psuApp .sensWater{ fill: rgba(0, 182, 255, .45); }#psuApp .sensWaterWave{ fill: rgba(0, 182, 255, .30); }#psuApp .sensInnerLine{ stroke: rgba(0,182,255,.65); stroke-width: 2; }#psuApp .menu{
      position:absolute;
      min-width: 220px;
      border:1px solid var(--border);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      padding:8px;
      display:none;
      z-index:20;
      backdrop-filter: blur(10px);
    }#psuApp[data-theme="light"] .menu{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
    }#psuApp .menu .mi{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid transparent;
      font-weight:900;
      font-size:13px;
      color: var(--text);
      display:flex;
      gap:10px;
      align-items:center;
    }#psuApp .menu .mi:hover{
      border-color: rgba(98,179,255,.35);
      background: rgba(98,179,255,.10);
    }#psuApp .menu .mi .k{ width:10px; height:10px; border-radius:99px; background: var(--accent); }#psuApp .menu .mi.green .k{ background: var(--ok); }#psuApp .menu .mi.gray .k{ background: rgba(154,166,191,.75); }#psuApp .menu .mi.noclick{ cursor: default; }#psuApp .menu .mi.noclick:hover{ border-color: transparent; background: transparent; }#psuApp .inlineBind{
      display:flex; gap:8px; align-items:center; width:100%;
    }#psuApp .miniInput{
      width:86px; padding:8px 10px;
      border-radius:10px; border:1px solid var(--border);
      background: var(--input); color: var(--text);
      font-weight:900;
    }#psuApp .miniBtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(98,179,255,.45);
      background: rgba(98,179,255,.12);
      color: var(--text);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }#psuApp .modal{
      position:fixed; inset:0;
      background: var(--overlay);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }#psuApp .modalCard{
      width: min(520px, 96vw);
      border:1px solid var(--border);
      border-radius:18px;
      background: var(--modal-bg);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }#psuApp[data-theme="light"] .modalCard{
      background: var(--modal-bg-light);
    }#psuApp .modalHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }#psuApp .modalHead b{ font-size:14px; }#psuApp .xbtn{ border-radius:12px; padding:8px 10px; }#psuApp .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-weight:900; font-size:12px;
    }#psuApp .tog{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
    }#psuApp .tog input{ width:auto; padding:0; margin:0; }#psuApp .tog.active{color:var(--text); border-color: rgba(98,179,255,.45); background: rgba(98,179,255,.10)}#psuApp .err{
      border:1px dashed rgba(255,107,107,.55);
      background: rgba(255,107,107,.10);
      border-radius:16px;
      padding:10px 12px;
      margin-top:14px;
      display:none;
      font-size:13px;
    }#psuApp .err b{color:var(--bad)}
/* --- интеграция в общий дизайн --- */
#psuApp{ background: transparent; }
#psuApp .wrap{ max-width: 100%; padding: 0; }
#psuApp header{ position: static; top:auto; margin: 0 0 12px 0; box-shadow:none; backdrop-filter:none; }
#psuApp header h1, #psuApp header .sub{ display:none; }
#psuApp main{ padding: 0; }

  
/* --- PSU: список БП и привязки --- */
#psuApp .psuPanel{ padding:12px; }
#psuApp .psuPanelHead{ align-items:center; justify-content:space-between; gap:12px; }
#psuApp .psuList{ display:flex; flex-direction:column; gap:10px; }
#psuApp .psuRow{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 10px;
  border: 1px solid rgba(148,163,184,.22);
  background: rgba(255,255,255,.02);
  border-radius: 14px;
}
#psuApp[data-theme="light"] .psuRow{
  background: rgba(15,23,42,.02);
  border-color: rgba(15,23,42,.10);
}
#psuApp .psuRow .meta{ font-size:12px; color: var(--muted); margin-top:2px; }
#psuApp .psuRow .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
#psuApp .psuRow .tag{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(34,197,94,.35);
  background: rgba(34,197,94,.10);
}
#psuApp .psuRow .tag.bad{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.10);
}
#psuApp .psuEditGrid{ grid-template-columns: 1fr 1fr 1fr; }
@media (max-width: 980px){
  #psuApp .psuEditGrid{ grid-template-columns: 1fr; }
}
#psuApp .nodePsu{
  font-size:12px;
  opacity:.95;
  fill: var(--muted);
}
#psuApp[data-theme="light"] .nodePsu{ fill: rgba(239,68,68,.92); }

#psuApp .psuBody{ fill: rgba(239,68,68,.14); stroke: rgba(239,68,68,.72); stroke-width: 3; }
#psuApp[data-theme="light"] .psuBody{ fill: rgba(239,68,68,.08); stroke: rgba(239,68,68,.92); }
#psuApp .psuEdge{ stroke: rgba(239,68,68,.92); }


/* ===== PSU: гармонизация под общий дизайн + общая тема ===== */
#psuApp{
  background: transparent;
  /* наследуем основные CSS-переменные от сайта; задаём только служебные */
  --ok: var(--accent);
  --bad: #ef4444;
  --warn: #f59e0b;
  --ring: 0 0 0 4px rgba(34,197,94,.12);
}

#psuApp #themeChip, #psuApp #themeLabel{ display:none !important; }

/* зелёные акценты как на сайте */
#psuApp input:focus, #psuApp select:focus{
  border-color: rgba(34,197,94,.55) !important;
  box-shadow: 0 0 0 4px rgba(34,197,94,.12) !important;
}
#psuApp .btn.primary{
  border-color: rgba(34,197,94,.55) !important;
  background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(34,197,94,.06)) !important;
}
#psuApp .btn:hover{ border-color: rgba(34,197,94,.38) !important; }
#psuApp .step.active{
  border-color: rgba(34,197,94,.45) !important;
  background: rgba(34,197,94,.10) !important;
}
#psuApp .step.active .n{
  border-color: rgba(34,197,94,.55) !important;
  background: rgba(34,197,94,.18) !important;
}
#psuApp .hintbox{
  border-color: rgba(34,197,94,.45) !important;
  background: rgba(34,197,94,.08) !important;
}

/* в светлой теме линии связей — красные */
#psuApp[data-theme="light"] .edgeLine{ stroke: rgba(239,68,68,.92) !important; }
#psuApp[data-theme="light"] .edgeLenText{ fill: rgba(239,68,68,.92) !important; }

/* статус без "JS:" */
#psuApp #statusText{ font-weight:700; }



/* ===== nav links (как кнопки) ===== */
.nav a{
  width:100%;
  text-align:left;
  background: transparent;
  border:1px solid var(--border);
  color: var(--text);
  padding: 12px 12px;
  border-radius: 14px;
  cursor:pointer;
  transition: .15s ease;
  display:flex; align-items:center; justify-content:flex-start; gap:10px;
  font-weight: 900;
  text-decoration:none;
}
.nav a:hover{ transform: translateY(-1px); }
.nav a.active{
  border-color: rgba(34,197,94,.55);
  box-shadow: 0 0 0 4px rgba(34,197,94,.12);
}

  </style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Питание датчиков</h1>
        <div class="subtitle">Визуальная схема • датчики, связи, БП</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <button class="btn" id="themeToggle" type="button" title="Переключить тему">Тема: —</button>
      <a class="pill mono" href="./index.html" style="text-decoration:none; color:inherit;">Главная</a>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="card-h">
        <b>Калькуляторы</b>
        <span class="pill">меню</span>
      </div>
      <div class="card-b">
        
<div class="nav">
  <a href="./liquid.html" class=""><span class="nav-title">Расчёт объема жидкости</span></a>
  <a href="./mount.html" class=""><span class="nav-title">Монтажные комплектующие</span></a>
  <a href="./psu.html" class="active"><span class="nav-title">Питание датчиков</span></a>
</div>
<div class="hint">Тема, оформление и сохранение настроек единые на всех страницах. Новые калькуляторы добавим сюда же.</div>

      </div>
    </section>

    <section class="card" id="calc-psu">
<div class="card-h">
<b>Питание датчиков</b>
<span class="pill">интегрировано</span>
</div>
<div class="card-b">
<div data-theme="dark" id="psuApp">
<div class="wrap" id="app">
<header>
<div>
<h1>Калькулятор питания датчиков — визуальная схема</h1>
<div class="sub">Клик датчик → <b>Привязать</b> → клик второй датчик. Или сразу “Привязать к №”. Клик по линии — длина. Перетаскивание: за иконку датчика.</div>
</div>
<div class="actions">
<div class="chip" id="statusChip" title="Статус скрипта"><span class="dot bad" id="statusDot"></span><span id="statusText">Загрузка…</span></div>
<div class="chip" id="themeChip" title="Переключить тему"><span class="dot"></span><span id="themeLabel">Тема</span></div>
<button class="btn ghost" id="resetBtn" title="Сбросить всё" type="button">Сброс</button>
<button class="btn" id="exportBtn" title="Экспортировать настройки в JSON" type="button">Экспорт</button>
<button class="btn" id="importBtn" title="Импортировать настройки из JSON" type="button">Импорт</button>
</div>
</header>
<noscript>
<div class="err" style="display:block">
<b>JavaScript отключён.</b> Включи JS в браузере — без него визуализатор и расчёт не работают.
    </div>
</noscript>
<div class="err" id="errBanner"></div>
<main>
<div class="card">
<div class="stepper" id="stepper"></div>
</div>
<section class="card stepPane" data-step="0">
<h2>Шаг 1 — Параметры</h2>
<div class="row">
<div class="field">
<label>Выход БП (напряжение), В (24–30)</label>
<input id="Vpsu" max="30" min="24" step="0.1" type="number"/>
<div class="help">Можно поднять до 30В, чтобы “купировать” просадку (если датчик допускает).</div>
</div>
<div class="field">
<label>Сечение жилы питания, мм²</label>
<input id="S" min="0.1" step="0.1" type="number"/>
<div class="help">Проводник: <b>медь (Cu)</b>. Петля “+/-”: <span class="mono">R(Ω/м)=2·0.0175/S</span>.</div>
</div>
</div>
<div class="divider"></div>
<div class="grid2" style="grid-template-columns:1fr 1fr">
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">Параметры датчика</h2>
<div class="tog" id="overrideToggle">
<input id="overrideChk" type="checkbox"/>
<div>
<div style="font-weight:950;color:var(--text)">Ввести свои значения</div>
<div style="font-size:12px;color:var(--muted)">По умолчанию поля заблокированы и выставлены твоими значениями.</div>
</div>
</div>
<div class="divider"></div>
<div class="row">
<div class="field">
<label>Минимальное напряжение на датчике, В</label>
<input id="Vmin" min="0" step="0.1" type="number"/>
</div>
<div class="field">
<label>Ток без обогрева, А</label>
<input id="Inorm" min="0" step="0.001" type="number"/>
</div>
<div class="field">
<label>Ток с обогревом, А</label>
<input id="Iheat" min="0" step="0.001" type="number"/>
</div>
</div>
<div class="help">В результатах покажем <b>2 сценария</b>: A — без обогрева, B — с обогревом (как задано на шаге 3).</div>
</div>
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">БП: запас мощности</h2>
<div class="row">
  <div class="field">
    <label>Запас по мощности, %</label>
    <input id="reservePct" min="0" step="1" type="number"/>
    <div class="help">Обычно 25–40% (у тебя сейчас — 30%).</div>
  </div>
</div>
<div class="divider"></div>
<div class="row">
  <div class="field">
    <label>Номинал БП по умолчанию (для добавления), Вт</label>
    <select id="psuNom">
      <option value="120">120 Вт</option>
      <option value="240" selected>240 Вт</option>
      <option value="480">480 Вт</option>
      <option value="custom">Свое значение</option>
    </select>
  </div>
  <div class="field">
    <label>Если “свое”: номинал, Вт</label>
    <input id="psuCustom" min="1" step="1" type="number"/>
  </div>
</div>
<div class="help">На шаге 2 можно добавить несколько БП — у каждого будут свои U/P/I и свои привязанные датчики.</div>
</div></div>
</div>
<div class="navrow">
<div></div>
<button class="btn primary" id="next0" type="button">Далее →</button>
</div>
</section>
<section class="card stepPane" data-step="1">
<h2>Шаг 2 — Визуализатор (связи и длины)</h2>
<div class="grid2">
<div class="field">
<div class="viz" id="viz">
<svg class="vizSvg" height="100%" id="svg" preserveaspectratio="none" viewbox="0 0 1000 560" width="100%"></svg>
<div class="menu" id="menu">
<div class="mi" id="miBind"><span class="k"></span>Привязать (кликом)</div>
<div class="mi noclick">
<span class="k"></span>
<div class="inlineBind">
<span style="opacity:.9">к №</span>
<input class="miniInput" id="bindToInput" min="1" step="1" type="number"/>
<button class="miniBtn" id="bindToBtn" type="button">OK</button>
</div>
</div>
<div class="mi noclick">
<span class="k"></span>
<div class="inlineBind">
<span style="opacity:.9">БП №</span>
<input class="miniInput" id="bindPsuInput" min="1" step="1" type="number"/>
<button class="miniBtn" id="bindPsuBtn" type="button">OK</button>
</div>
</div>
<div class="mi gray" id="miUnbindPsu"><span class="k"></span>Отвязать от БП</div>
<div class="mi gray" id="miClear"><span class="k"></span>Удалить связи</div>
</div>
</div>
<div class="help">Добавляй связи: датчик ↔ датчик и БП ↔ датчик. Длину связи задавай кликом по линии. Перетаскивание: за иконку (датчика или БП).</div>
</div>
<div class="field">
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">Количество датчиков</h2>
<input id="N" min="1" step="1" type="number"/>
<div class="help">Изменение количества датчиков сбрасывает связи.</div>
<div class="divider"></div>
<h2 style="margin-bottom:10px">Быстрые действия</h2>
<div class="row">
<button class="btn" id="autoChainBtn" type="button">Сделать цепочку 1–N</button>
</div>
<div class="help">Длины связей по умолчанию ставятся 1м. Дальше кликай по связям и меняй длину.</div>
<div class="divider"></div>
<h2 style="margin-bottom:10px;color:var(--bad)">Добавить связь между</h2>
<div class="row">
<div class="field" style="min-width:140px">
<label>От датчика</label>
<input id="linkFrom" min="1" step="1" type="number"/>
</div>
<div class="field" style="min-width:140px">
<label>К датчику</label>
<input id="linkTo" min="1" step="1" type="number"/>
</div>
<div class="field" style="min-width:160px;align-self:flex-end">
<button class="btn primary" id="addLinkBtn" type="button">Добавить связь</button>
</div>
</div>
<div class="help">Связь создаётся сразу (подходит для ответвлений). Длина по умолчанию 1м — меняется кликом по линии.</div>
<div class="divider"></div>
<div class="hintbox">
<b>Как пользоваться:</b><br/>
              1) Перетащи датчики в нужные места<br/>
              2) Клик по датчику → “Привязать” → клик по второму<br/>
              3) Или: клик по датчику → “к №” → введи номер → OK<br/>
              4) Или: “Добавить связь между” справа (от № к №)<br/>
              5) Клик по линии → введи длину
            </div>
</div>
</div>
<div class="field">
<div class="card psuPanel">
<div class="row psuPanelHead">
<div>
<div style="font-weight:950">Блоки питания</div>
<div class="help" style="margin-top:4px">Добавляй БП и распределяй датчики кликом или через меню датчика.</div>
</div>
<button class="btn" id="addPsuBtn" type="button">+ Добавить БП</button>
</div>
<div class="divider"></div>
<div class="help" id="psuHint"></div>
<div class="psuList" id="psuList"></div>
<div class="help" style="margin-top:10px">Совет: нажми <b>Привязать датчики</b> у БП и кликай по датчикам на схеме.</div>
</div>
</div>
</div>
<div class="navrow">
<button class="btn" id="prev1" type="button">← Назад</button>
<button class="btn primary" id="next1" type="button">Результат →</button>
</div>
</section>
<section class="card stepPane" data-step="2">
<h2>Шаг 3 — Результаты</h2>
<div class="grid2" style="grid-template-columns:1fr 1fr">
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">Сценарий A — без обогрева</h2>
<div id="sumA"></div>
</div>
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">Сценарий B — с обогревом</h2>
<div class="row">
<div class="field">
<label>Как считать обогрев</label>
<select id="heatMode">
<option selected="" value="all">Все датчики</option>
<option value="none">Обогрев не используется</option>
<option value="pct">Процент датчиков</option>
<option value="count">Количество датчиков</option>
</select>
</div>
<div class="field">
<label>Значение (% или шт)</label>
<input id="heatValue" min="0" step="1" type="number"/>
</div>
</div>
<div class="help">Частичный обогрев: <span class="mono">Iэфф = Inorm·(1−f) + Iheat·f</span>.</div>
<div class="divider"></div>
<div id="sumB"></div>
</div>
</div>
<div class="divider"></div>
<div class="card" style="padding:12px;background:rgba(255,255,255,.02)">
<h2 style="margin-bottom:10px">Проверка по датчикам</h2>
<div class="help">Расчёт предполагает сеть-дерево от источника. Если есть петли — покажем предупреждение.</div>
<div style="margin-top:10px;overflow:auto">
<table class="table" id="nodeTable"></table>
</div>
</div>
<div class="divider"></div>
<div class="row">
<div class="field">
<div class="okbox">
<b>Если не хватает по мощности:</b> увеличь суммарную мощность БП (или ставь больше БП), учитывая запас.
          </div>
</div>
<div class="field">
<div class="dangerbox">
<b>Если не проходит по напряжению:</b> увеличь сечение, сократи длины, раздели на зоны (добавь БП ближе), либо подними V БП (до 30В) в пределах допуска.
          </div>
</div>
</div>
<div class="navrow">
<button class="btn" id="prev2" type="button">← Назад</button>
<button class="btn primary" id="toStep1" type="button">К настройкам</button>
</div>
</section>
</main>
</div>
<input accept="application/json" id="fileInput" style="display:none" type="file"/>
<div class="modal" id="modal">
<div class="modalCard">
<div class="modalHead">
<b>Длина связи</b>
<button class="btn xbtn" id="closeModal" type="button">Закрыть</button>
</div>
<div class="row">
<div class="field">
<label>Связь</label>
<div class="pill" id="edgeLabel">—</div>
</div>
<div class="field">
<label>Длина, м</label>
<input id="edgeLen" min="0" step="0.1" type="number"/>
</div>
</div>
<div class="navrow">
<button class="btn" id="delEdge" type="button">Удалить связь</button>
<button class="btn primary" id="saveEdge" type="button">Сохранить</button>
</div>
</div>
</div>
<div class="modal" id="psuModal">
<div class="modalCard">
<div class="modalHead">
<b>Блок питания</b>
<button class="btn xbtn" id="closePsuModal" type="button">Закрыть</button>
</div>
<div class="row">
<div class="field" style="flex:1">
<label>Название</label>
<input id="psuName" placeholder="Например: БП шкафа №1" type="text"/>
</div>
</div>
<div class="grid2 psuEditGrid">
<div class="field">
<label>Напряжение, В</label>
<input id="psuU" min="0" placeholder="24" step="0.1" type="number"/>
</div>
<div class="field">
<label>Мощность, Вт</label>
<input id="psuP" min="0" placeholder="240" step="1" type="number"/>
</div>
<div class="field">
<label>Ток, А</label>
<input id="psuI" min="0" placeholder="10" step="0.01" type="number"/>
</div>
</div>
<div class="help" style="margin-top:8px">Введи любые <b>2</b> значения — третье посчитается автоматически (P = U × I).</div>
<div class="navrow">
<button class="btn" id="delPsuBtn" type="button">Удалить БП</button>
<button class="btn primary" id="savePsuBtn" type="button">Сохранить</button>
</div>
</div>
</div>
<script>

    // ===== Общая тема (светлая/тёмная) =====
    const THEME_KEY = "monitron_site_theme";
    const themeBtn = document.getElementById("themeToggle");

    function systemTheme(){
      try{
        return (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) ? "light" : "dark";
      }catch(_){ return "dark"; }
    }
    function themeLabel(t){ return t === "light" ? "Светлая" : "Тёмная"; }

    function applyTheme(t){
      document.documentElement.setAttribute("data-theme", t);
      if(themeBtn) themeBtn.textContent = "Тема: " + themeLabel(t);

      // синхронизируем встроенный калькулятор питания датчиков
      const psu = document.getElementById("psuApp");
      if(psu) psu.setAttribute("data-theme", t);
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      applyTheme(saved || systemTheme());
    }

    if(themeBtn){
      themeBtn.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-theme") || systemTheme();
        const next = (cur === "light") ? "dark" : "light";
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });
    }
    initTheme();

    // второй проход после инициализации PSU-скрипта (на случай, если он трогает тему)
    window.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        const cur = document.documentElement.getAttribute("data-theme") || systemTheme();
        applyTheme(cur);
      }, 0);
    }, { once:true });

(function(){
  const errBanner = document.getElementById('errBanner');
  function showError(msg){
    try{
      if(errBanner){
        errBanner.style.display = 'block';
        errBanner.innerHTML = `<b>Ошибка:</b> ${String(msg).replaceAll('<','&lt;')}`;
      }
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('statusText');
      if(dot) dot.className = 'dot bad';
      if(txt) txt.textContent = 'Ошибка';
    }catch(_){/*noop*/}
  }

  window.addEventListener('error', (e) => showError(e.error ? e.error.message : e.message));
  window.addEventListener('unhandledrejection', (e) => showError(e.reason ? e.reason : 'unhandledrejection'));

  const $ = (id)=> document.getElementById(id);
  const num = (v, d=0) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : d;
  };
  const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
  const ceil = (x)=> Math.ceil(num(x,0));
  const fmt = (x, d=1)=> {
    const n = num(x, 0);
    return Number.isFinite(n) ? n.toFixed(d) : '—';
  };
  const fmtInt = (x)=> String(Math.round(num(x,0)));

  const STORAGE_KEY = 'psu_graph_calc_v7';

  function psuNominalW(s){
    const sel = (s.psuNom || '240');
    if(sel === 'custom') return Math.max(1, num(s.psuCustom, 240));
    return Math.max(1, num(sel, 240));
  }

  const defaultState = () => ({
    theme: 'dark',
    step: 0,
    // defaults for NEW PSUs
    Vpsu: 24,
    psuNom: '240',
    psuCustom: 240,

    // cable & sensor params
    S: 0.7,
    reservePct: 30,
    override: false,
    Vmin: 17,
    Inorm: 0.05,
    Iheat: 0.65,

    // heat scenario controls
    heatMode: 'all',
    heatValue: 20,

    // graph
    N: 5,
    nodes: [],        // sensors: {id, x, y}
    psus: [],         // PSUs: {id:-k, x,y, name, U,P,I}
    edges: [],        // {a,b,len}
    sensorPsu: []     // index by sensor id => psuIndex (1..M) or 0
  });

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const data = JSON.parse(raw);
      const s = { ...defaultState(), ...data };
      // drop legacy fields
      delete s.derate;
      delete s.sourceId;
      return s;
    }catch(_){
      return defaultState();
    }
  }

  let state = loadState();

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){/*noop*/}
  }

  function ensureArrayLen(arr, len, fill){
    const a = Array.isArray(arr) ? arr : [];
    if(a.length < len){
      for(let i=a.length;i<len;i++) a[i] = fill;
    }
    return a;
  }

  function normalizePsuIds(){
    // keep stable order by current abs(id)
    state.psus = Array.isArray(state.psus) ? state.psus.slice() : [];
    state.psus.sort((a,b)=> Math.abs(num(a.id,-999)) - Math.abs(num(b.id,-999)));

    const map = new Map(); // oldAbs -> newAbs
    state.psus.forEach((p, idx) => {
      const oldAbs = Math.abs(num(p.id, -(idx+1)));
      const newAbs = idx+1;
      map.set(oldAbs, newAbs);
      p.id = -newAbs;
    });

    // rewrite edges
    state.edges = Array.isArray(state.edges) ? state.edges : [];
    for(const e of state.edges){
      if(num(e.a,0) < 0){
        const oldAbs = Math.abs(num(e.a,0));
        if(map.has(oldAbs)) e.a = -map.get(oldAbs);
      }
      if(num(e.b,0) < 0){
        const oldAbs = Math.abs(num(e.b,0));
        if(map.has(oldAbs)) e.b = -map.get(oldAbs);
      }
      // normalize order
      const a = num(e.a,0), b = num(e.b,0);
      if(a > b){ e.a = b; e.b = a; }
    }

    // rewrite sensorPsu mapping
    state.sensorPsu = ensureArrayLen(state.sensorPsu, state.N+1, 0);
    for(let i=1;i<=state.N;i++){
      const old = Math.abs(num(state.sensorPsu[i], 1));
      state.sensorPsu[i] = map.get(old) || 1;
    }
  }

  function initGraph(){
    state.N = Math.max(1, Math.floor(num(state.N, 5)));

    // sensors
    state.nodes = Array.isArray(state.nodes) ? state.nodes : [];
    const need = state.N;
    const byId = new Map(state.nodes.map(n => [num(n.id,0), n]));
    state.nodes = [];
    for(let i=1;i<=need;i++){
      const old = byId.get(i);
      const angle = (i-1)/Math.max(1,need) * Math.PI*2;
      state.nodes.push({
        id: i,
        x: clamp(num(old?.x, 520 + Math.cos(angle)*240), 60, 940),
        y: clamp(num(old?.y, 280 + Math.sin(angle)*180), 80, 520)
      });
    }

    // PSUs
    state.psus = Array.isArray(state.psus) ? state.psus : [];
    if(state.psus.length === 0){
      const P = psuNominalW(state);
      const U = clamp(num(state.Vpsu,24), 0, 60);
      state.psus = [{ id:-1, x:140, y:150, name:'БП 1', U, P, I: (U>0? P/U : 0) }];
    }
    // clamp PSU fields
    state.psus = state.psus.map((p, idx)=>{
      const absId = Math.abs(num(p.id, idx+1)) || (idx+1);
      const U = Math.max(0, num(p.U, clamp(num(state.Vpsu,24),0,60)));
      const P = Math.max(0, num(p.P, psuNominalW(state)));
      const I = Math.max(0, num(p.I, (U>0? P/U : 0)));
      return {
        id: -absId,
        x: clamp(num(p.x, 140), 70, 930),
        y: clamp(num(p.y, 150 + idx*90), 70, 530),
        name: (p.name && String(p.name).trim()) ? String(p.name).trim() : `БП ${absId}`,
        U, P, I
      };
    });

    // sensor -> PSU mapping
    state.sensorPsu = ensureArrayLen(state.sensorPsu, state.N+1, 0);
    for(let i=1;i<=state.N;i++){
      let v = Math.floor(num(state.sensorPsu[i], 1));
      if(!(v>=1 && v<=state.psus.length)) v = 1;
      state.sensorPsu[i] = v;
    }

    normalizePsuIds();

    // edges
    const validIds = new Set(state.nodes.map(n=>n.id).concat(state.psus.map(p=>p.id)));
    state.edges = Array.isArray(state.edges) ? state.edges : [];
    state.edges = state.edges
      .map(e => ({ a: Math.floor(num(e.a,0)), b: Math.floor(num(e.b,0)), len: Math.max(0, num(e.len, 1)) }))
      .filter(e => e.a !== e.b && validIds.has(e.a) && validIds.has(e.b));
    // normalize and dedupe
    const seen = new Set();
    const out = [];
    for(const e of state.edges){
      const a = Math.min(e.a,e.b), b = Math.max(e.a,e.b);
      const k = `${a}-${b}`;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push({a,b,len:e.len});
    }
    state.edges = out;

    // migration: if there are NO PSU edges at all, link PSU#1 to sensor#1 (so voltage calc works)
    if(!state.edges.some(e => e.a<0 || e.b<0)){
      state.edges.push({a:-1, b:1, len: 1});
    }
  }

  initGraph();

  // ===== Steps =====
  const steps = [
    { title: 'Параметры', desc: 'V, S, БП' },
    { title: 'Схема', desc: 'датчики, БП, длины' },
    { title: 'Результат', desc: 'A и B' },
  ];

  function renderStepper(){
    const el = $('stepper');
    if(!el) return;
    el.innerHTML = steps.map((s, i) => {
      const cls = (i === state.step) ? 'step active' : 'step';
      return `<div class="${cls}" data-stepbtn="${i}"><span class="n">${i+1}</span><div><div style="font-weight:950">${s.title}</div><div class="sub">${s.desc}</div></div></div>`;
    }).join('');
    el.querySelectorAll('[data-stepbtn]').forEach(b => b.addEventListener('click', () => goStep(Number(b.getAttribute('data-stepbtn')))));
  }

  function goStep(i){
    state.step = clamp(Math.floor(num(i,0)), 0, 2);
    document.querySelectorAll('.stepPane').forEach(p => {
      const s = Number(p.getAttribute('data-step'));
      p.style.display = (s === state.step) ? 'block' : 'none';
    });
    renderStepper();
    saveState();
  }

  // ===== Graph utils =====
  const svg = $('svg');
  const viz = $('viz');
  const menu = $('menu');
  const modal = $('modal');
  const edgeLabel = $('edgeLabel');
  const edgeLen = $('edgeLen');

  let activeNodeId = null;
  let bindFromId = null;
  let activeBindPsu = 0; // psuIndex
  let draggingId = null;
  let dragOffset = {x:0,y:0};
  let editingEdgeKey = null;

  function nodeLabel(id){
    id = Math.floor(num(id,0));
    if(id < 0) return `БП ${Math.abs(id)}`;
    return `#${id}`;
  }

  function edgeKey(a,b){
    const x = Math.min(a,b), y = Math.max(a,b);
    return `${x}-${y}`;
  }

  function upsertEdge(a,b,len=1){
    a = Math.floor(num(a,0));
    b = Math.floor(num(b,0));
    if(a === b) return;
    const k = edgeKey(a,b);
    const e = state.edges.find(e => edgeKey(e.a,e.b) === k);
    if(e) e.len = Math.max(0, num(len, e.len ?? 1));
    else state.edges.push({ a: Math.min(a,b), b: Math.max(a,b), len: Math.max(0, num(len, 1)) });
  }

  function deleteEdgeByKey(k){
    state.edges = state.edges.filter(e => edgeKey(e.a,e.b) !== k);
  }

  function removePsuEdgesForSensor(sensorId){
    sensorId = Math.floor(num(sensorId,0));
    state.edges = state.edges.filter(e => {
      const a = e.a, b = e.b;
      if(a === sensorId && b < 0) return false;
      if(b === sensorId && a < 0) return false;
      return true;
    });
  }

  function assignSensorToPsu(sensorId, psuIndex, makeEdge=true){
    sensorId = Math.floor(num(sensorId,0));
    psuIndex = Math.floor(num(psuIndex,0));
    if(!(sensorId>=1 && sensorId<=state.N)) return;
    if(!(psuIndex>=1 && psuIndex<=state.psus.length)) return;

    // ensure only one PSU per sensor
    removePsuEdgesForSensor(sensorId);
    state.sensorPsu[sensorId] = psuIndex;
    if(makeEdge){
      upsertEdge(-psuIndex, sensorId, 1);
    }
  }

  function unbindSensorFromPsu(sensorId){
    sensorId = Math.floor(num(sensorId,0));
    if(!(sensorId>=1 && sensorId<=state.N)) return;
    removePsuEdgesForSensor(sensorId);
    state.sensorPsu[sensorId] = 0;
  }

  function svgPointFromClient(clientX, clientY){
    const rect = svg.getBoundingClientRect();
    const x = (clientX - rect.left) / rect.width * 1000;
    const y = (clientY - rect.top) / rect.height * 560;
    return {x, y};
  }

  function hideMenu(){
    if(menu) menu.style.display = 'none';
    activeNodeId = null;
  }

  function showMenuAt(clientX, clientY, nodeId){
    activeNodeId = nodeId;
    $('bindToInput').value = '';
    $('bindPsuInput').value = '';
    const rect = viz.getBoundingClientRect();
    menu.style.left = `${clientX - rect.left + 10}px`;
    menu.style.top = `${clientY - rect.top + 10}px`;
    menu.style.display = 'block';
    setTimeout(() => { try{ $('bindToInput').focus(); }catch(_){ } }, 0);
  }

  function sensorIcon(n){
    const w = 44, h = 58, rx = 10;
    const x = n.x - w/2, y = n.y - h/2;
    const waterH = 22;
    const wy = y + h - waterH;
    const wave = `
      <path class="sensWaterWave" d="
        M ${x+4} ${wy+8}
        C ${x+12} ${wy+2}, ${x+20} ${wy+14}, ${x+28} ${wy+8}
        C ${x+34} ${wy+4}, ${x+36} ${wy+12}, ${x+40} ${wy+8}
        L ${x+40} ${y+h-6}
        L ${x+4} ${y+h-6}
        Z" />
    `;
    return `
      <g>
        <rect class="sensOuterSoft" x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}"></rect>
        <rect class="sensOuter" x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}"></rect>
        <clipPath id="clip-${n.id}">
          <rect x="${x+3}" y="${y+3}" width="${w-6}" height="${h-6}" rx="${rx-3}"></rect>
        </clipPath>
        <g clip-path="url(#clip-${n.id})">
          <rect class="sensWater" x="${x+3}" y="${wy}" width="${w-6}" height="${waterH}" rx="0"></rect>
          ${wave}
        </g>
        <line class="sensInnerLine" x1="${x+10}" y1="${y+h*0.45}" x2="${x+w-10}" y2="${y+h*0.45}"></line>
        <line class="sensInnerLine" x1="${x+10}" y1="${y+h*0.58}" x2="${x+w-10}" y2="${y+h*0.58}"></line>
      </g>
    `;
  }

  function psuIcon(p){
    const w = 74, h = 46, rx = 12;
    const x = p.x - w/2, y = p.y - h/2;
    const label = `БП${Math.abs(p.id)}`;
    return `
      <g>
        <rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}" class="psuBody" />
        <text x="${p.x}" y="${p.y+6}" text-anchor="middle" class="nodePsu">${label}</text>
      </g>
    `;
  }

  function draw(){
    if(!svg) return;
    const sensors = state.nodes;
    const psus = state.psus;
    const nodesById = new Map();
    sensors.forEach(n => nodesById.set(n.id, n));
    psus.forEach(p => nodesById.set(p.id, p));

    const edges = state.edges.filter(e => nodesById.has(e.a) && nodesById.has(e.b) && e.a !== e.b);

    const defs = `
      <defs>
        <filter id="soft">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.35)"/>
        </filter>
      </defs>
    `;

    const edgeEls = edges.map(e => {
      const a = nodesById.get(e.a), b = nodesById.get(e.b);
      const mx = (a.x+b.x)/2, my = (a.y+b.y)/2;
      const lenText = (e.len ?? 0) ? String(Math.round(num(e.len,0)*10)/10) : '0';
      const isPsuEdge = (e.a<0 || e.b<0);
      const cls = isPsuEdge ? 'edgeLine psuEdge' : 'edgeLine';
      return `
        <g data-edge="${edgeKey(e.a,e.b)}">
          <line class="${cls}" x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}"></line>
          <line class="edgeHit" x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" data-edgehit="${edgeKey(e.a,e.b)}"></line>
          <text class="edgeText" x="${mx+6}" y="${my-6}">${lenText}</text>
        </g>
      `;
    }).join('');

    const psuEls = psus.map(p => {
      const hitW = 88, hitH = 62;
      const hx = p.x - hitW/2, hy = p.y - hitH/2;
      return `
        <g data-node="${p.id}" filter="url(#soft)">
          ${psuIcon(p)}
          <rect class="nodeHitCursor" x="${hx}" y="${hy}" width="${hitW}" height="${hitH}" fill="transparent" data-nodehit="${p.id}"></rect>
        </g>
      `;
    }).join('');

    const sensEls = sensors.map(n => {
      const hitW = 64, hitH = 84;
      const hx = n.x - hitW/2, hy = n.y - hitH/2;
      return `
        <g data-node="${n.id}" filter="url(#soft)">
          ${sensorIcon(n)}
          <text class="nodeNum" x="${n.x-8}" y="${n.y-40}">${n.id}</text>
          <rect class="nodeHitCursor" x="${hx}" y="${hy}" width="${hitW}" height="${hitH}" fill="transparent" data-nodehit="${n.id}"></rect>
        </g>
      `;
    }).join('');

    let hint = '';
    if(bindFromId){
      hint = `<text x="14" y="60" class="edgeText" style="font-size:18px;opacity:.9">Режим привязки: кликни цель для связи с ${nodeLabel(bindFromId)}</text>`;
    }else if(activeBindPsu){
      hint = `<text x="14" y="60" class="edgeText" style="font-size:18px;opacity:.9">Привязка к БП ${activeBindPsu}: кликай по датчикам</text>`;
    }

    svg.innerHTML = `${defs}<rect x="0" y="0" width="1000" height="560" fill="transparent"></rect>${edgeEls}${psuEls}${sensEls}${hint}`;

    svg.querySelectorAll('[data-nodehit]').forEach(el => {
      el.addEventListener('pointerdown', onNodePointerDown);
      el.addEventListener('click', onNodeClick);
    });
    svg.querySelectorAll('[data-edgehit]').forEach(el => el.addEventListener('click', onEdgeClick));
  }

  function getNodeById(id){
    id = Math.floor(num(id,0));
    if(id < 0) return state.psus.find(p => p.id === id);
    return state.nodes.find(n => n.id === id);
  }

  function onNodeClick(e){
    e.stopPropagation();
    const id = Math.floor(num(e.target.getAttribute('data-nodehit'), 0));
    if(!id) return;

    // active PSU bulk bind
    if(activeBindPsu && id > 0){
      assignSensorToPsu(id, activeBindPsu, true);
      hideMenu();
      draw();
      computeAndRender();
      saveState();
      return;
    }

    // click-to-bind
    if(bindFromId && bindFromId !== id){
      upsertEdge(bindFromId, id, 1);
      // if PSU<->sensor, also set assignment
      if(bindFromId < 0 && id > 0) assignSensorToPsu(id, Math.abs(bindFromId), false);
      if(bindFromId > 0 && id < 0) assignSensorToPsu(bindFromId, Math.abs(id), false);

      bindFromId = null;
      hideMenu();
      draw();
      computeAndRender();
      saveState();
      return;
    }

    // PSU click => edit
    if(id < 0){
      openPsuModal(Math.abs(id));
      return;
    }

    // sensor click => menu
    showMenuAt(e.clientX, e.clientY, id);
  }

  function onNodePointerDown(e){
    const id = Math.floor(num(e.target.getAttribute('data-nodehit'), 0));
    if(!id) return;
    draggingId = id;
    hideMenu();
    const pt = svgPointFromClient(e.clientX, e.clientY);
    const node = getNodeById(id);
    if(node){
      dragOffset.x = node.x - pt.x;
      dragOffset.y = node.y - pt.y;
    }
    svg.setPointerCapture(e.pointerId);
    svg.addEventListener('pointermove', onPointerMove);
    svg.addEventListener('pointerup', onPointerUp);
  }

  function onPointerMove(e){
    if(!draggingId) return;
    const pt = svgPointFromClient(e.clientX, e.clientY);
    const node = getNodeById(draggingId);
    if(!node) return;
    node.x = clamp(pt.x + dragOffset.x, 70, 930);
    node.y = clamp(pt.y + dragOffset.y, 70, 530);
    draw();
  }

  function onPointerUp(){
    svg.removeEventListener('pointermove', onPointerMove);
    svg.removeEventListener('pointerup', onPointerUp);
    draggingId = null;
    computeAndRender();
    saveState();
  }

  function onEdgeClick(e){
    e.stopPropagation();
    const k = e.target.getAttribute('data-edgehit');
    if(!k) return;
    editingEdgeKey = k;
    const ed = state.edges.find(x => edgeKey(x.a,x.b) === k);
    if(!ed) return;
    edgeLabel.textContent = `${nodeLabel(ed.a)} — ${nodeLabel(ed.b)}`;
    edgeLen.value = ed.len ?? 1;
    modal.style.display = 'flex';
    setTimeout(() => { try{ edgeLen.focus(); edgeLen.select(); }catch(_){ } }, 0);
  }

  function closeModal(){
    modal.style.display = 'none';
    editingEdgeKey = null;
  }

  $('closeModal').addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

  // Enter = save edge
  edgeLen.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      $('saveEdge').click();
    }else if(e.key === 'Escape'){
      e.preventDefault();
      closeModal();
    }
  });

  $('saveEdge').addEventListener('click', () => {
    if(!editingEdgeKey) return closeModal();
    const ed = state.edges.find(x => edgeKey(x.a,x.b) === editingEdgeKey);
    if(ed){
      ed.len = Math.max(0, num(edgeLen.value, ed.len ?? 1));
      saveState();
      draw();
      computeAndRender();
    }
    closeModal();
  });

  $('delEdge').addEventListener('click', () => {
    if(!editingEdgeKey) return closeModal();
    deleteEdgeByKey(editingEdgeKey);
    saveState();
    draw();
    computeAndRender();
    closeModal();
  });

  // background click
  svg.addEventListener('click', (e) => {
    if(e.target === svg){
      hideMenu();
      bindFromId = null;
      activeBindPsu = 0;
      draw();
    }
  });

  // menu actions
  $('miBind').addEventListener('click', () => {
    if(activeNodeId){
      bindFromId = activeNodeId;
      hideMenu();
      draw();
    }
  });

  function bindToNumber(){
    if(!activeNodeId) return;
    const target = Math.floor(num($('bindToInput').value, 0));
    if(!(target >= 1 && target <= state.N)){
      alert(`Введи номер датчика от 1 до ${state.N}`);
      return;
    }
    if(target === activeNodeId){
      alert('Нельзя привязать датчик к самому себе.');
      return;
    }
    upsertEdge(activeNodeId, target, 1);
    bindFromId = null;
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  }

  $('bindToBtn').addEventListener('click', (e) => { e.stopPropagation(); bindToNumber(); });
  $('bindToInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){ e.preventDefault(); e.stopPropagation(); bindToNumber(); }
    if(e.key === 'Escape'){ hideMenu(); }
  });

  function bindToPsu(){
    if(!activeNodeId) return;
    const k = Math.floor(num($('bindPsuInput').value, 0));
    if(!(k >= 1 && k <= state.psus.length)){
      alert(`Введи номер БП от 1 до ${state.psus.length}`);
      return;
    }
    assignSensorToPsu(activeNodeId, k, true);
    bindFromId = null;
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  }

  $('bindPsuBtn').addEventListener('click', (e) => { e.stopPropagation(); bindToPsu(); });
  $('bindPsuInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){ e.preventDefault(); e.stopPropagation(); bindToPsu(); }
    if(e.key === 'Escape'){ hideMenu(); }
  });

  $('miUnbindPsu').addEventListener('click', () => {
    if(!activeNodeId) return;
    unbindSensorFromPsu(activeNodeId);
    bindFromId = null;
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  });

  $('miClear').addEventListener('click', () => {
    if(!activeNodeId) return;
    state.edges = state.edges.filter(e => e.a !== activeNodeId && e.b !== activeNodeId);
    bindFromId = null;
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  });

  // add link by numbers
  function addLinkByNumbers(){
    const from = Math.floor(num($('linkFrom').value, 0));
    const to = Math.floor(num($('linkTo').value, 0));
    if(!(from >= 1 && from <= state.N) || !(to >= 1 && to <= state.N)){
      alert(`Введи номера датчиков в диапазоне 1..${state.N}`);
      return;
    }
    if(from === to){
      alert('Нельзя сделать связь датчика с самим собой.');
      return;
    }
    upsertEdge(from, to, 1);
    bindFromId = null;
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  }

  $('addLinkBtn').addEventListener('click', (e) => { e.stopPropagation(); addLinkByNumbers(); });
  ['linkFrom','linkTo'].forEach(id => $(id).addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){ e.preventDefault(); addLinkByNumbers(); }
  }));

  $('autoChainBtn').addEventListener('click', () => {
    // keep PSU edges, reset only sensor-sensor edges
    state.edges = state.edges.filter(e => e.a<0 || e.b<0);
    for(let i=1;i<state.N;i++) upsertEdge(i, i+1, 1);
    draw();
    computeAndRender();
    saveState();
  });

  function copperLoopRperM(S){
    const s = Math.max(0.0001, num(S, 0.7));
    return 2 * 0.0175 / s;
  }

  // ===== PSU panel + modal =====
  const psuModal = $('psuModal');
  let editingPsu = 0; // psuIndex

  function autoFixPsuInputs(){
    const U = num($('psuU').value, NaN);
    const P = num($('psuP').value, NaN);
    const I = num($('psuI').value, NaN);
    const hasU = Number.isFinite(U) && U>0;
    const hasP = Number.isFinite(P) && P>=0;
    const hasI = Number.isFinite(I) && I>=0;

    // compute missing third if exactly 2 are present
    const cnt = (hasU?1:0) + (hasP?1:0) + (hasI?1:0);
    if(cnt < 2) return;

    if(!hasP && hasU && hasI){
      $('psuP').value = String(Math.round(U*I));
    }else if(!hasI && hasU && hasP){
      $('psuI').value = (U>0 ? (P/U).toFixed(2) : '0');
    }else if(!hasU && hasP && hasI){
      $('psuU').value = (I>0 ? (P/I).toFixed(1) : '0');
    }
  }

  ['psuU','psuP','psuI'].forEach(id => $(id).addEventListener('input', () => {
    autoFixPsuInputs();
  }));

  function openPsuModal(psuIndex){
    psuIndex = Math.floor(num(psuIndex,0));
    if(!(psuIndex>=1 && psuIndex<=state.psus.length)) return;
    editingPsu = psuIndex;
    const p = state.psus[psuIndex-1];
    $('psuName').value = p.name || `БП ${psuIndex}`;
    $('psuU').value = String(num(p.U, state.Vpsu));
    $('psuP').value = String(Math.round(num(p.P, psuNominalW(state))));
    $('psuI').value = String(num(p.I, (num(p.U,24)>0 ? num(p.P,240)/num(p.U,24) : 0)).toFixed(2));
    psuModal.style.display = 'flex';
    setTimeout(() => { try{ $('psuName').focus(); $('psuName').select(); }catch(_){ } }, 0);
  }

  function closePsuModal(){
    psuModal.style.display = 'none';
    editingPsu = 0;
  }

  $('closePsuModal').addEventListener('click', closePsuModal);
  psuModal.addEventListener('click', (e) => { if(e.target === psuModal) closePsuModal(); });

  $('savePsuBtn').addEventListener('click', () => {
    if(!editingPsu) return closePsuModal();
    const p = state.psus[editingPsu-1];
    if(!p) return closePsuModal();
    const name = String($('psuName').value || '').trim();
    const U = Math.max(0, num($('psuU').value, p.U));
    const P = Math.max(0, num($('psuP').value, p.P));
    const I = Math.max(0, num($('psuI').value, p.I));
    p.name = name || `БП ${editingPsu}`;
    p.U = U;
    p.P = P;
    p.I = I;
    saveState();
    draw();
    computeAndRender();
    renderPsuList();
    closePsuModal();
  });

  function deletePsu(psuIndex){
    psuIndex = Math.floor(num(psuIndex,0));
    if(!(psuIndex>=1 && psuIndex<=state.psus.length)) return;
    if(state.psus.length === 1){
      alert('Нельзя удалить последний БП.');
      return;
    }
    if(!confirm(`Удалить БП ${psuIndex}?`)) return;

    const psuId = -psuIndex;
    // remove PSU node
    state.psus = state.psus.filter(p => p.id !== psuId);
    // remove edges to that PSU
    state.edges = state.edges.filter(e => e.a !== psuId && e.b !== psuId);
    // re-normalize IDs (this will also remap sensorPsu)
    normalizePsuIds();

    saveState();
    draw();
    computeAndRender();
    renderPsuList();
  }

  $('delPsuBtn').addEventListener('click', () => {
    if(!editingPsu) return closePsuModal();
    closePsuModal();
    deletePsu(editingPsu);
  });

  function addPsu(){
    const idx = state.psus.length + 1;
    const P = psuNominalW(state);
    const U = Math.max(0, num(state.Vpsu, 24));
    const y = clamp(150 + (idx-1)*90, 70, 530);
    state.psus.push({ id: -idx, x: 140, y, name: `БП ${idx}`, U, P, I: (U>0 ? P/U : 0) });
    normalizePsuIds();
    saveState();
    draw();
    computeAndRender();
    renderPsuList();
  }

  $('addPsuBtn').addEventListener('click', addPsu);

  function renderPsuList(){
    const host = $('psuList');
    const hint = $('psuHint');
    if(!host) return;

    const counts = new Array(state.psus.length+1).fill(0);
    for(let i=1;i<=state.N;i++){
      const k = Math.floor(num(state.sensorPsu[i],0));
      if(k>=1 && k<=state.psus.length) counts[k]++;
    }

    if(hint){
      hint.innerHTML = `БП на схеме — красные блоки. Клик по БП открывает настройки. Привязка датчиков: <b>Привязать (кликом)</b> → клик по БП, или кнопкой ниже.`;
    }

    host.innerHTML = state.psus.map((p, i) => {
      const k = i+1;
      const n = counts[k];
      const meta = `${fmt(p.U,1)} В · ${fmtInt(p.P)} Вт · ${fmt(num(p.I,0),2)} А · датчиков: <b>${n}</b>`;
      const isActive = (activeBindPsu === k);
      return `
        <div class="psuRow">
          <div>
            <div style="font-weight:950">${p.name || ('БП ' + k)} <span class="tag">#${k}</span></div>
            <div class="meta">${meta}</div>
          </div>
          <div class="actions">
            <button class="btn" type="button" data-psu-bind="${k}">${isActive ? 'Привязка: ВКЛ' : 'Привязать датчики'}</button>
            <button class="btn" type="button" data-psu-edit="${k}">Настроить</button>
            <button class="btn" type="button" data-psu-del="${k}">Удалить</button>
          </div>
        </div>
      `;
    }).join('');

    host.querySelectorAll('[data-psu-edit]').forEach(b => b.addEventListener('click', () => openPsuModal(Number(b.getAttribute('data-psu-edit')))));
    host.querySelectorAll('[data-psu-del]').forEach(b => b.addEventListener('click', () => deletePsu(Number(b.getAttribute('data-psu-del')))));
    host.querySelectorAll('[data-psu-bind]').forEach(b => b.addEventListener('click', () => {
      const k = Number(b.getAttribute('data-psu-bind'));
      activeBindPsu = (activeBindPsu === k) ? 0 : k;
      bindFromId = null;
      hideMenu();
      draw();
      renderPsuList();
    }));
  }

  // ===== Calculation =====
  function buildAdj(){
    const ids = new Set(state.nodes.map(n=>n.id).concat(state.psus.map(p=>p.id)));
    const adj = new Map();
    for(const id of ids) adj.set(id, []);
    for(const e of state.edges){
      if(!ids.has(e.a) || !ids.has(e.b)) continue;
      const len = Math.max(0, num(e.len, 1));
      adj.get(e.a).push({to:e.b, len});
      adj.get(e.b).push({to:e.a, len});
    }
    return adj;
  }

  function computeScenario(IperSensor){
    const N = state.N;
    const rPerM = copperLoopRperM(state.S);
    const reserve = 1 + Math.max(0, num(state.reservePct,30))/100;
    const VminReq = num(state.Vmin,17);
    const adj = buildAdj();

    const Va = new Array(N+1).fill(NaN);
    const parent = new Array(N+1).fill(null); // node id
    const plen = new Array(N+1).fill(0);

    const perPsu = [];

    for(let k=1;k<=state.psus.length;k++){
      const psu = state.psus[k-1];
      const psuId = -k;
      const U0 = num(psu.U, num(state.Vpsu,24));
      const Pmax = Math.max(0, num(psu.P, psuNominalW(state)));
      const assigned = [];
      for(let i=1;i<=N;i++) if(Math.floor(num(state.sensorPsu[i],0)) === k) assigned.push(i);

      // BFS restricted to assigned sensors
      const q = [psuId];
      const vis = new Set([psuId]);
      const order = [];

      // for PSU node, store its voltage separately
      const Vnode = new Map();
      Vnode.set(psuId, U0);

      while(q.length){
        const cur = q.shift();
        const neigh = adj.get(cur) || [];
        for(const nb of neigh){
          const to = nb.to;
          if(vis.has(to)) continue;

          if(to < 0){
            // do not traverse into other PSUs
            continue;
          }
          // sensor must be assigned to this PSU
          if(Math.floor(num(state.sensorPsu[to],0)) !== k) continue;

          vis.add(to);
          parent[to] = cur;
          plen[to] = nb.len;
          order.push(to);
          q.push(to);
        }
      }

      // children map for subtree sizes
      const children = new Map();
      function addChild(p, c){
        if(!children.has(p)) children.set(p, []);
        children.get(p).push(c);
      }
      for(const sId of order){
        const pId = parent[sId];
        addChild(pId, sId);
      }

      const sub = new Map();
      function subCount(id){
        if(sub.has(id)) return sub.get(id);
        if(id < 0) {
          let sum = 0;
          const ch = children.get(id) || [];
          for(const c of ch) sum += subCount(c);
          sub.set(id, sum);
          return sum;
        }
        let sum = 1;
        const ch = children.get(id) || [];
        for(const c of ch) sum += subCount(c);
        sub.set(id, sum);
        return sum;
      }
      subCount(psuId);

      // forward voltage calc
      const stack = [psuId];
      while(stack.length){
        const cur = stack.pop();
        const Vcur = Vnode.get(cur);
        const ch = children.get(cur) || [];
        for(const c of ch){
          const Iseg = sub.get(c) * IperSensor;
          const dV = Iseg * rPerM * plen[c];
          Vnode.set(c, Vcur - dV);
          Va[c] = Vcur - dV;
          stack.push(c);
        }
      }

      // metrics
      let VminNode = Infinity;
      let VminId = null;
      let visitedSensors = 0;
      for(const sId of assigned){
        if(vis.has(sId)){
          visitedSensors++;
          const V = Vnode.get(sId);
          if(Number.isFinite(V) && V < VminNode){
            VminNode = V; VminId = sId;
          }
        }
      }
      if(!Number.isFinite(VminNode)) VminNode = U0;

      const unreachable = assigned.filter(x => !vis.has(x));
      const Itotal = assigned.length * IperSensor;
      const Praw = U0 * Itotal;
      const Pneed = Praw * reserve;

      const okPower = Pneed <= (Pmax + 1e-9);
      const okVolt = (VminNode >= (VminReq - 1e-9)) && unreachable.length === 0;

      perPsu.push({
        k,
        name: psu.name || (`БП ${k}`),
        U0,
        Pmax,
        assigned: assigned.length,
        visited: visitedSensors,
        unreachable,
        Itotal,
        Pneed,
        VminNode,
        VminId,
        okPower,
        okVolt
      });
    }

    return { perPsu, V: Va, parent, plen, rPerM };
  }

  function heatFraction(){
    const mode = state.heatMode || 'all';
    const v = Math.max(0, num(state.heatValue, 20));
    const N = state.N;
    if(mode === 'none') return 0;
    if(mode === 'all') return 1;
    if(mode === 'pct') return clamp(v/100, 0, 1);
    if(mode === 'count') return clamp(v/Math.max(1,N), 0, 1);
    return 1;
  }

  function renderSummary(hostId, calc){
    const host = $(hostId);
    if(!host) return;

    const allOkP = calc.perPsu.every(p => p.okPower);
    const allOkV = calc.perPsu.every(p => p.okVolt);

    const badge = (ok, label) => `<span class="badge ${ok?'ok':'bad'}">${label}: <b>${ok ? 'OK' : 'провал'}</b></span>`;

    const rows = calc.perPsu.map(p => {
      const un = p.unreachable.length ? ` <span class="tag bad">нет связи: ${p.unreachable.length}</span>` : '';
      return `
        <tr>
          <td><b>${p.name}</b> <span class="tag">БП#${p.k}</span>${un}</td>
          <td>${fmt(p.U0,1)}</td>
          <td>${fmtInt(p.assigned)}</td>
          <td>${fmt(p.Itotal,2)}</td>
          <td>${fmt(p.Pneed,1)}</td>
          <td>${fmt(p.Pmax,1)}</td>
          <td>${p.okPower ? '<span class="tag">OK</span>' : '<span class="tag bad">НЕ ХВАТАЕТ</span>'}</td>
          <td>${fmt(p.VminNode,2)}${p.VminId?` (датч. #${p.VminId})`:''}</td>
          <td>${p.okVolt ? '<span class="tag">OK</span>' : '<span class="tag bad">НЕ ПРОХОДИТ</span>'}</td>
        </tr>
      `;
    }).join('');

    host.innerHTML = `
      <div class="row" style="margin-bottom:10px">
        <div class="field">${badge(allOkP, 'Мощность')}</div>
        <div class="field">${badge(allOkV, 'Напряжение')}</div>
      </div>
      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>БП</th>
              <th>U, В</th>
              <th>Датч.</th>
              <th>I, А</th>
              <th>Pнужно, Вт</th>
              <th>Pмакс, Вт</th>
              <th>По мощности</th>
              <th>Vмин, В</th>
              <th>По напряжению</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderNodeTable(calcA, calcB){
    const tbl = $('nodeTable');
    if(!tbl) return;

    const rows = [];
    rows.push(`<tr>
      <th>Датчик</th>
      <th>БП</th>
      <th>Родитель</th>
      <th>L, м</th>
      <th>V(A), В</th>
      <th>V(B), В</th>
      <th>Статус</th>
    </tr>`);

    for(let i=1;i<=state.N;i++){
      const psuIdx = Math.floor(num(state.sensorPsu[i],0));
      const psuLbl = (psuIdx>=1 && psuIdx<=state.psus.length) ? `БП${psuIdx}` : '—';
      const p = calcA.parent[i];
      const pl = (p===null || p===undefined) ? '—' : nodeLabel(p);
      const L = calcA.plen[i] ? fmt(calcA.plen[i],1) : '—';
      const Va = calcA.V[i];
      const Vb = calcB.V[i];
      const okA = Number.isFinite(Va) && Va >= num(state.Vmin,17);
      const okB = Number.isFinite(Vb) && Vb >= num(state.Vmin,17);
      const ok = okA && okB;
      const status = ok ? '<span class="tag">OK</span>' : '<span class="tag bad">ПРОСАДКА / НЕТ СВЯЗИ</span>';
      rows.push(`<tr>
        <td><b>#${i}</b></td>
        <td>${psuLbl}</td>
        <td>${pl}</td>
        <td>${L}</td>
        <td>${Number.isFinite(Va)?fmt(Va,2):'—'}</td>
        <td>${Number.isFinite(Vb)?fmt(Vb,2):'—'}</td>
        <td>${status}</td>
      </tr>`);
    }

    tbl.innerHTML = rows.join('');
  }

  function computeAndRender(){
    // guard
    initGraph();

    const f = heatFraction();
    const Ieff = num(state.Inorm,0.05) * (1 - f) + num(state.Iheat,0.65) * f;

    const calcA = computeScenario(num(state.Inorm,0.05));
    const calcB = computeScenario(Ieff);

    renderSummary('sumA', calcA);
    renderSummary('sumB', calcB);
    renderNodeTable(calcA, calcB);

    renderPsuList();

    // status
    const dot = $('statusDot');
    const txt = $('statusText');
    if(dot) dot.className = 'dot ok';
    if(txt) txt.textContent = 'Готово';
    if(errBanner) errBanner.style.display = 'none';
  }

  // ===== UI wiring =====
  function setOverrideUI(enabled){
    const dis = !enabled;
    $('Vmin').disabled = dis;
    $('Inorm').disabled = dis;
    $('Iheat').disabled = dis;
    const tog = $('overrideToggle');
    if(enabled) tog.classList.add('active');
    else tog.classList.remove('active');
  }

  function applyToUI(){
    $('Vpsu').value = clamp(num(state.Vpsu,24), 0, 60);
    $('S').value = num(state.S, 0.7);
    $('reservePct').value = num(state.reservePct,30);

    $('psuNom').value = state.psuNom || '240';
    $('psuCustom').value = num(state.psuCustom,240);

    $('overrideChk').checked = !!state.override;
    $('Vmin').value = num(state.Vmin,17);
    $('Inorm').value = num(state.Inorm,0.05);
    $('Iheat').value = num(state.Iheat,0.65);
    setOverrideUI(!!state.override);

    $('N').value = Math.max(1, Math.floor(num(state.N,5)));

    // add-link defaults
    $('linkFrom').value = 1;
    $('linkTo').value = Math.min(2, state.N);

    $('heatMode').value = state.heatMode || 'all';
    $('heatValue').value = num(state.heatValue,20);

    renderStepper();
    draw();
    renderPsuList();
  }

  $('Vpsu').addEventListener('input', () => { state.Vpsu = clamp(num($('Vpsu').value,24), 0, 60); computeAndRender(); saveState(); });
  $('S').addEventListener('input', () => { state.S = Math.max(0.1, num($('S').value,0.7)); computeAndRender(); saveState(); });
  $('reservePct').addEventListener('input', () => { state.reservePct = Math.max(0, num($('reservePct').value,30)); computeAndRender(); saveState(); });

  $('psuNom').addEventListener('change', () => { state.psuNom = $('psuNom').value; computeAndRender(); saveState(); });
  $('psuCustom').addEventListener('input', () => { state.psuCustom = Math.max(1, num($('psuCustom').value,240)); computeAndRender(); saveState(); });

  $('overrideChk').addEventListener('change', () => {
    state.override = $('overrideChk').checked;
    setOverrideUI(state.override);
    if(!state.override){
      state.Vmin = 17; state.Inorm = 0.05; state.Iheat = 0.65;
      $('Vmin').value = state.Vmin; $('Inorm').value = state.Inorm; $('Iheat').value = state.Iheat;
    }else{
      state.Vmin = num($('Vmin').value,17);
      state.Inorm = num($('Inorm').value,0.05);
      state.Iheat = num($('Iheat').value,0.65);
    }
    computeAndRender(); saveState();
  });

  ['Vmin','Inorm','Iheat'].forEach(id => {
    $(id).addEventListener('input', () => {
      if(!state.override) return;
      state.Vmin = num($('Vmin').value,17);
      state.Inorm = num($('Inorm').value,0.05);
      state.Iheat = num($('Iheat').value,0.65);
      computeAndRender(); saveState();
    });
  });

  $('N').addEventListener('change', () => {
    state.N = Math.max(1, Math.floor(num($('N').value,5)));
    // resize sensorPsu
    state.sensorPsu = ensureArrayLen(state.sensorPsu, state.N+1, 1);
    for(let i=1;i<=state.N;i++){
      let k = Math.floor(num(state.sensorPsu[i],1));
      if(!(k>=1 && k<=state.psus.length)) k = 1;
      state.sensorPsu[i] = k;
    }
    // remove edges to removed sensors
    const valid = new Set([...Array(state.N+1).keys()].slice(1).concat(state.psus.map(p=>p.id)));
    state.edges = state.edges.filter(e => valid.has(e.a) && valid.has(e.b));

    initGraph();
    hideMenu();
    draw();
    computeAndRender();
    saveState();
  });

  $('heatMode').addEventListener('change', () => { state.heatMode = $('heatMode').value; computeAndRender(); saveState(); });
  $('heatValue').addEventListener('input', () => { state.heatValue = Math.max(0, num($('heatValue').value,20)); computeAndRender(); saveState(); });

  $('next0').addEventListener('click', () => goStep(1));
  $('next1').addEventListener('click', () => goStep(2));
  $('prev1').addEventListener('click', () => goStep(0));
  $('prev2').addEventListener('click', () => goStep(1));
  $('toStep1').addEventListener('click', () => goStep(0));

  // reset
  $('resetBtn').addEventListener('click', () => {
    if(!confirm('Сбросить всё к настройкам по умолчанию?')) return;
    state = defaultState();
    initGraph();
    applyToUI();
    saveState();
    goStep(0);
    computeAndRender();
  });

  // export
  $('exportBtn').addEventListener('click', () => {
    const payload = JSON.stringify({ ...state, step: 0 }, null, 2);
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const dt = new Date();
    const pad = (x)=> String(x).padStart(2,'0');
    a.download = `psu_graph_calc_${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // import
  $('importBtn').addEventListener('click', () => $('fileInput').click());
  $('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      state = { ...defaultState(), ...data, step: 0 };
      delete state.derate;
      delete state.sourceId;
      initGraph();
      applyToUI();
      saveState();
      goStep(0);
      computeAndRender();
    }catch(_){
      alert('Не удалось импортировать JSON. Проверь файл.');
    }finally{
      e.target.value = '';
    }
  });

  // init
  applyToUI();
  goStep(num(state.step,0));
  draw();
  computeAndRender();

})();
})();
</script>
</div>
</div>
</section>
  </div>

  <div class="toast" id="toast">Готово</div>
</div>


</body>
</html>
