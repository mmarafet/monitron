<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Монтажные комплектующие</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent2:#62b3ff;
      --border:rgba(148,163,184,.18);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --pad:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    :root[data-theme="light"]{
      --bg:#f7f8fb;
      --card:#ffffff;
      --muted:#5b6474;
      --text:#0b1220;
      --border:rgba(15,23,42,.12);
      --shadow: 0 10px 24px rgba(2,6,23,.10);
      --accent:#16a34a;
      --accent2:#0b74ff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(98,179,255,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1120px; margin: 0 auto; padding: 22px 16px 44px; }
    header.top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap; margin-bottom: 14px;
    }
    .title{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(98,179,255,.25));
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    h1{ font-size: 18px; line-height: 1.2; margin:0; letter-spacing:.2px; }
    .subtitle{ margin:2px 0 0; color:var(--muted); font-size: 13px; }

    .grid{ display:grid; grid-template-columns: 280px 1fr; gap: 14px; }
    @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 14px var(--pad);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{ font-size: 14px; }
    .card-b{ padding: var(--pad); }

    .pill{
      font-size: 12px;
      color: var(--muted);
      border:1px solid var(--border);
      padding: 3px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .nav{ display:flex; flex-direction:column; gap:10px; }
    .nav a{
      width:100%;
      text-align:left;
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      display:flex; align-items:center; justify-content:flex-start; gap:10px;
      font-weight: 900;
      text-decoration:none;
    }
    .nav a:hover{ transform: translateY(-1px); }
    .nav a.active{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }
    .nav .nav-title{ width:100%; display:block; font-size: 13px; line-height: 1.2; }

    .hint{ margin-top: 10px; font-size: 12px; color: var(--muted); line-height: 1.35; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 560px){ .row{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }

    .actions{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px; align-items:center; }
    .btn{
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 900;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(34,197,94,.55);
      background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(34,197,94,.10));
    }

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(2,6,23,.85); color: #fff;
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: .18s ease;
      font-size: 13px;
      max-width: calc(100% - 24px);
      z-index: 9999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    /* ===== Mounting stepper (FIX: было #view-mount, теперь #calc-mount) ===== */
    #calc-mount .m-stepper{ display:flex; flex-wrap:wrap; gap:8px; }
    #calc-mount .m-step{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
    }
    #calc-mount .m-step .n{
      width:22px;height:22px;border-radius:8px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    #calc-mount .m-step.active{
      color:var(--text);
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.10);
    }
    #calc-mount .m-step.active .n{
      color:var(--text);
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.18);
    }
    #calc-mount .m-stepPane{ display:none; }
    #calc-mount .m-stepPane.active{ display:block; }

    #calc-mount .tiles{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    @media (max-width: 560px){ #calc-mount .tiles{ grid-template-columns: 1fr; } }

    #calc-mount .tile{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.02);
      transition: .15s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    #calc-mount .tile:hover{ transform: translateY(-1px); }
    #calc-mount .tile.active{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(34,197,94,.06));
    }

    #calc-mount .switches{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ #calc-mount .switches{ grid-template-columns: 1fr; } }

    #calc-mount .tog{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:var(--text);
    }
    #calc-mount .tog small{ color:var(--muted); font-weight:700; }
    #calc-mount .tog input{ width:auto; }
    #calc-mount .tog.disabled{ opacity:.65; cursor:not-allowed; }

    #calc-mount .note{
      border:1px dashed rgba(98,179,255,.45);
      background: rgba(98,179,255,.08);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
      color:var(--text);
    }
    #calc-mount .warn{
      border:1px dashed rgba(255,200,87,.55);
      background: rgba(255,200,87,.10);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
    }

    #calc-mount .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
    }
    #calc-mount .table th,#calc-mount .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      vertical-align: top;
    }
    #calc-mount .table th{
      text-align:left;
      color:var(--muted);
      font-weight:900;
      background: rgba(255,255,255,.04);
    }
    #calc-mount .table tr:last-child td{ border-bottom:none; }
  </style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Монтажные комплектующие</h1>
        <div class="subtitle">Степпер (структура) • дальше подключим Excel</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <button class="btn" id="themeToggle" type="button" title="Переключить тему">Тема: —</button>
      <a class="pill mono" href="./index.html" style="text-decoration:none; color:inherit;">Главная</a>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="card-h">
        <b>Калькуляторы</b>
        <span class="pill">меню</span>
      </div>
      <div class="card-b">
        <div class="nav">
          <a href="./liquid.html"><span class="nav-title">Расчёт объема жидкости</span></a>
          <a href="./mount.html" class="active"><span class="nav-title">Монтажные комплектующие</span></a>
          <a href="./psu.html"><span class="nav-title">Питание датчиков</span></a>
        </div>
        <div class="hint">Тема, оформление и сохранение настроек единые на всех страницах. Новые калькуляторы добавим сюда же.</div>
      </div>
    </section>

    <section class="card" id="calc-mount">
      <div class="card-h">
        <b>Монтажные комплектующие</b>
        <span class="pill">степпер (структура)</span>
      </div>

      <div class="card-b">
        <div class="m-stepper" id="m_stepper"></div>

        <div class="m-stepPane" id="m_step0">
          <div class="hint" style="margin-top:12px">Шаг 1 — Тип объекта</div>
          <div class="tiles" id="m_objTiles" style="margin-top:10px"></div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <div></div><button class="btn primary" id="m_next0" type="button">Далее →</button>
          </div>
        </div>

        <div class="m-stepPane" id="m_step1">
          <div class="hint" style="margin-top:12px">Шаг 2 — Крепление к стене (если применимо)</div>
          <div id="m_wallBlock" style="margin-top:10px"><div class="tiles" id="m_wallTiles"></div></div>
          <div class="note" id="m_wallNA" style="display:none; margin-top:10px">Для <b>резервуара</b> крепление к стене не требуется.</div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="m_prev1" type="button">← Назад</button>
            <button class="btn primary" id="m_next1" type="button">Далее →</button>
          </div>
        </div>

        <div class="m-stepPane" id="m_step2">
          <div class="hint" style="margin-top:12px">Шаг 3 — Условия прокладки и защиты</div>

          <div class="switches" style="margin-top:10px">
            <div class="tog" id="m_togGofra">
              <div>Гофра<br/><small id="m_gofraSub">—</small></div>
              <input id="m_gofra" type="checkbox"/>
            </div>
            <div class="tog" id="m_togEx">
              <div>Взрывозащитное исполнение<br/><small id="m_exSub">—</small></div>
              <input id="m_ex" type="checkbox"/>
            </div>
            <div class="tog" id="m_togVib">
              <div>Вибрация<br/><small>Если да → поплавки в расчёт</small></div>
              <input id="m_vib" type="checkbox"/>
            </div>
            <div class="tog">
              <div>Соединители<br/><small>указываются вручную</small></div>
              <span class="pill">OK</span>
            </div>
          </div>

          <div class="warn" id="m_floatNote" style="display:none; margin-top:10px">
            ✅ Включена <b>вибрация</b> — в ведомость будут добавлены <b>поплавки</b> (привяжем к Excel).
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="m_prev2" type="button">← Назад</button>
            <button class="btn primary" id="m_next2" type="button">Далее →</button>
          </div>
        </div>

        <div class="m-stepPane" id="m_step3">
          <div class="hint" style="margin-top:12px">Шаг 4 — Датчики и гидротрасса</div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Кол-во датчиков (шт.)</label>
              <input id="m_sensors" min="0" placeholder="например: 12" step="1" type="number"/>
            </div>
            <div class="tog" id="m_togHeat" style="height:48px; align-self:end;">
              <div>Обогрев датчиков<br/><small>если включить → потребление выше</small></div>
              <input id="m_heat" type="checkbox"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Длина трассы (м)</label>
              <input id="m_len" min="0" placeholder="например: 50" step="0.1" type="number"/>
            </div>
            <div>
              <label>Диаметр трубки (мм)</label>
              <input id="m_diam" min="0" placeholder="например: 12" step="0.1" type="number"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Кол-во углов (шт.)</label>
              <input id="m_elbows" min="0" placeholder="0" step="1" type="number"/>
            </div>
            <div>
              <label>Соединители для углов (шт.) (если есть)</label>
              <input id="m_connElbows" min="0" placeholder="0" step="1" type="number"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Кол-во тройников (шт.)</label>
              <input id="m_tees" min="0" placeholder="0" step="1" type="number"/>
            </div>
            <div>
              <label>Соединители для тройников (шт.) (если есть)</label>
              <input id="m_connTees" min="0" placeholder="0" step="1" type="number"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Кол-во четверников (шт.)</label>
              <input id="m_crosses" min="0" placeholder="0" step="1" type="number"/>
            </div>
            <div>
              <label>Соединители для четверников (шт.) (если есть)</label>
              <input id="m_connCrosses" min="0" placeholder="0" step="1" type="number"/>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="m_prev3" type="button">← Назад</button>
            <button class="btn primary" id="m_next3" type="button">Далее →</button>
          </div>
        </div>

        <div class="m-stepPane" id="m_step4">
          <div class="hint" style="margin-top:12px">Шаг 5 — Серверы, питание и связь</div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Количество серверов (шт.)</label>
              <input id="m_servers" min="0" placeholder="например: 1" step="1" type="number"/>
            </div>
            <div>
              <label>Расстояние от крайнего датчика до сервера (м)</label>
              <input id="m_distLast" min="0" placeholder="например: 80" step="0.1" type="number"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Кол-во блоков питания (шт.)</label>
              <input id="m_psuCount" min="0" placeholder="например: 2" step="1" type="number"/>
            </div>
            <div>
              <label>Мощность одного БП (Вт)</label>
              <input id="m_psuPower" min="0" placeholder="например: 240" step="1" type="number"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Расстояние от сервера до точки подключения (м)</label>
              <input id="m_distConn" min="0" placeholder="например: 20" step="0.1" type="number"/>
            </div>
            <div>
              <label>Интернет заказчика</label>
              <select id="m_custNet">
                <option value="1">Да</option>
                <option value="0">Нет</option>
              </select>
            </div>
          </div>

          <div class="switches" style="margin-top:10px">
            <div class="tog" id="m_togAnt">
              <div>Интернет-антенна<br/><small>нужна/не нужна</small></div>
              <input id="m_ant" type="checkbox"/>
            </div>
            <div class="tog" id="m_togAntPlace">
              <div>Размещение антенны<br/><small>в сервере / выносная</small></div>
              <select id="m_antPlace" style="width:160px">
                <option value="in">В сервере</option>
                <option value="out">Выносная</option>
              </select>
            </div>
          </div>

          <div class="row" id="m_antDistRow" style="margin-top:10px">
            <div>
              <label>Расстояние от сервера до антенны (м)</label>
              <input id="m_antDist" min="0" placeholder="например: 15" step="0.1" type="number"/>
            </div>
            <div class="note">Дистанция учитывается только при <b>выносной</b> антенне.</div>
          </div>

          <div id="m_tunnelBlock" style="display:none; margin-top:10px">
            <div class="switches">
              <div class="tog" id="m_togTr">
                <div>Трансформатор<br/><small>только для тоннеля</small></div>
                <input id="m_tr" type="checkbox"/>
              </div>
              <div class="tog">
                <div>Кол-во и расстояние<br/><small>если нужен</small></div>
                <div style="display:flex; gap:8px; align-items:center">
                  <input id="m_trCount" min="0" placeholder="шт" step="1" style="width:92px" type="number"/>
                  <input id="m_trDist" min="0" placeholder="м" step="0.1" style="width:92px" type="number"/>
                </div>
              </div>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="m_prev4" type="button">← Назад</button>
            <button class="btn primary" id="m_next4" type="button">Итог →</button>
          </div>
        </div>

        <div class="m-stepPane" id="m_step5">
          <div class="hint" style="margin-top:12px">Шаг 6 — Итог (пока структура)</div>

          <div class="note" style="margin-top:10px">
            Сейчас это <b>структура</b> и свод введённых параметров. Когда пришлёшь Excel — подставлю реальные позиции/формулы и получится ведомость комплектующих.
          </div>

          <div style="margin-top:10px; overflow:auto">
            <table class="table" id="m_outTable"></table>
          </div>

          <div class="actions">
            <button class="btn primary" id="m_copy">Скопировать итог</button>
            <button class="btn" id="m_reset">Сбросить</button>
            <span class="hint" id="m_status" style="margin:0;">—</span>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="m_prev5" type="button">← Назад</button>
            <div></div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <div class="toast" id="toast">Готово</div>
</div>

<script>
  // ===== Общая тема (светлая/тёмная) =====
  const THEME_KEY = "monitron_site_theme";
  const themeBtn = document.getElementById("themeToggle");

  function systemTheme(){
    try{
      return (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) ? "light" : "dark";
    }catch(_){ return "dark"; }
  }
  function themeLabel(t){ return t === "light" ? "Светлая" : "Тёмная"; }

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    if(themeBtn) themeBtn.textContent = "Тема: " + themeLabel(t);
  }

  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    applyTheme(saved || systemTheme());
  }

  if(themeBtn){
    themeBtn.addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme") || systemTheme();
      const next = (cur === "light") ? "dark" : "light";
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });
  }
  initTheme();
</script>

<script>
(() => {
  const toast = document.getElementById("toast");
  function showToast(msg){
    if(!toast) return;
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(() => toast.classList.remove("show"), 1600);
  }
  const byId = (id) => document.getElementById(id);

  // ===== монтажный степпер (структура + сохранение) =====
  const MKEY = "calc_mounting_state_v1";
  const mSteps = [
    { title:"Тип объекта" },
    { title:"Крепление" },
    { title:"Условия" },
    { title:"Трасса" },
    { title:"Сервер/связь" },
    { title:"Итог" },
  ];
  const m = {
    step: 0,
    obj: "building",
    wall: "anchor",
    gofra: false,
    ex: false,
    vib: false,
    sensors: 0,
    heat: false,
    len: 0,
    diam: 0,
    elbows: 0, connElbows: 0,
    tees: 0, connTees: 0,
    crosses: 0, connCrosses: 0,
    servers: 0,
    distLast: 0,
    psuCount: 0, psuPower: 0,
    distConn: 0,
    custNet: true,
    ant: false, antPlace: "in", antDist: 0,
    tr: false, trCount: 0, trDist: 0,
  };

  function mLoad(){ try{ const raw = localStorage.getItem(MKEY); if(!raw) return; Object.assign(m, JSON.parse(raw)||{}); }catch(_ ){} }
  function mSave(){ try{ localStorage.setItem(MKEY, JSON.stringify(m)); }catch(_ ){} }

  const m_stepper = byId("m_stepper");
  function mRenderStepper(){
    m_stepper.innerHTML = "";
    mSteps.forEach((s, i) => {
      const el = document.createElement("div");
      el.className = "m-step" + (m.step === i ? " active" : "");
      el.innerHTML = `<div class="n">${i+1}</div><div>${s.title}</div>`;
      el.addEventListener("click", () => mGo(i));
      m_stepper.appendChild(el);
    });
  }
  function mShowPane(){
    for(let i=0;i<mSteps.length;i++) byId("m_step"+i).classList.toggle("active", m.step===i);
  }
  function mGo(i){
    m.step = Math.max(0, Math.min(mSteps.length-1, i));
    mRenderStepper();
    mShowPane();
    mApplyVisibility();
    mRenderOutput();
    mSave();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  const objTiles = byId("m_objTiles");
  const objList = [
    { key:"building", label:"Здание" },
    { key:"tank", label:"Резервуар" },
    { key:"tunnel", label:"Тоннель" },
    { key:"special", label:"Спец. назначение" },
  ];
  function mRenderObjTiles(){
    objTiles.innerHTML = "";
    objList.forEach(o => {
      const el = document.createElement("div");
      el.className = "tile" + (m.obj===o.key ? " active" : "");
      el.innerHTML = `<div>${o.label}</div><span class="pill">выбор</span>`;
      el.addEventListener("click", () => {
        m.obj = o.key;
        if(m.obj === "tank") m.gofra = true;
        mRenderObjTiles();
        mApplyVisibility();
        mRenderOutput();
        mSave();
      });
      objTiles.appendChild(el);
    });
  }

  const wallTiles = byId("m_wallTiles");
  const wallList = [
    { key:"anchor", label:"Обычный анкер" },
    { key:"chem", label:"Химический анкер" },
  ];
  function mRenderWallTiles(){
    wallTiles.innerHTML = "";
    wallList.forEach(w => {
      const el = document.createElement("div");
      el.className = "tile" + (m.wall===w.key ? " active" : "");
      el.innerHTML = `<div>${w.label}</div><span class="pill">стена</span>`;
      el.addEventListener("click", () => {
        m.wall = w.key;
        mRenderWallTiles();
        mRenderOutput();
        mSave();
      });
      wallTiles.appendChild(el);
    });
  }

  function mBindToggles(){
    const gofra = byId("m_gofra");
    const ex = byId("m_ex");
    const vib = byId("m_vib");

    const gofraWrap = byId("m_togGofra");
    const exWrap = byId("m_togEx");
    const vibWrap = byId("m_togVib");

    const gofraSub = byId("m_gofraSub");
    const exSub = byId("m_exSub");
    const floatNote = byId("m_floatNote");

    function sync(){
      gofra.checked = !!m.gofra;
      ex.checked = !!m.ex;
      vib.checked = !!m.vib;
      floatNote.style.display = m.vib ? "block" : "none";

      gofraSub.textContent = (m.obj === "tank") ? "для резервуара всегда ДА" : "по необходимости";
      exSub.textContent = (m.obj === "tank") ? "для резервуара скрыто" : "по необходимости";

      if(m.obj === "tank"){
        m.gofra = true;
        gofra.checked = true;
        gofraWrap.classList.add("disabled");
        gofra.disabled = true;

        exWrap.classList.add("disabled");
        ex.disabled = true;
        ex.checked = false;
        m.ex = false;
      } else {
        gofraWrap.classList.remove("disabled");
        gofra.disabled = false;
        exWrap.classList.remove("disabled");
        ex.disabled = false;
      }
    }

    gofraWrap.addEventListener("click", (e)=>{ if(m.obj==="tank") return; if(e.target.tagName.toLowerCase()==="input") return; gofra.checked=!gofra.checked; gofra.dispatchEvent(new Event("change")); });
    exWrap.addEventListener("click", (e)=>{ if(m.obj==="tank") return; if(e.target.tagName.toLowerCase()==="input") return; ex.checked=!ex.checked; ex.dispatchEvent(new Event("change")); });
    vibWrap.addEventListener("click", (e)=>{ if(e.target.tagName.toLowerCase()==="input") return; vib.checked=!vib.checked; vib.dispatchEvent(new Event("change")); });

    gofra.addEventListener("change", ()=>{ m.gofra = !!gofra.checked; sync(); mRenderOutput(); mSave(); });
    ex.addEventListener("change", ()=>{ m.ex = !!ex.checked; sync(); mRenderOutput(); mSave(); });
    vib.addEventListener("change", ()=>{ m.vib = !!vib.checked; sync(); mRenderOutput(); mSave(); });

    sync();
    mBindToggles._sync = sync;
  }

  function mBindNums(){
    const num = (id, key) => {
      const el = byId(id);
      const apply = () => { m[key] = Number(el.value || 0); mRenderOutput(); mSave(); };
      el.addEventListener("input", apply);
      el.addEventListener("change", apply);
    };
    num("m_sensors","sensors"); num("m_len","len"); num("m_diam","diam");
    num("m_elbows","elbows"); num("m_connElbows","connElbows");
    num("m_tees","tees"); num("m_connTees","connTees");
    num("m_crosses","crosses"); num("m_connCrosses","connCrosses");

    const heat = byId("m_heat");
    const heatWrap = byId("m_togHeat");
    heatWrap.addEventListener("click", (e)=>{ if(e.target.tagName.toLowerCase()==="input") return; heat.checked=!heat.checked; heat.dispatchEvent(new Event("change")); });
    heat.addEventListener("change", ()=>{ m.heat = !!heat.checked; mRenderOutput(); mSave(); });

    num("m_servers","servers"); num("m_distLast","distLast");
    num("m_psuCount","psuCount"); num("m_psuPower","psuPower");
    num("m_distConn","distConn"); num("m_trCount","trCount"); num("m_trDist","trDist");

    byId("m_custNet").addEventListener("change", (e)=>{ m.custNet = (e.target.value === "1"); mRenderOutput(); mSave(); });

    const ant = byId("m_ant"); const antWrap = byId("m_togAnt");
    const antPlace = byId("m_antPlace"); const antDist = byId("m_antDist");
    antWrap.addEventListener("click", (e)=>{ if(e.target.tagName.toLowerCase()==="input") return; ant.checked=!ant.checked; ant.dispatchEvent(new Event("change")); });
    ant.addEventListener("change", ()=>{ m.ant = !!ant.checked; mApplyVisibility(); mRenderOutput(); mSave(); });
    antPlace.addEventListener("change", ()=>{ m.antPlace = antPlace.value; mApplyVisibility(); mRenderOutput(); mSave(); });
    antDist.addEventListener("input", ()=>{ m.antDist = Number(antDist.value || 0); mRenderOutput(); mSave(); });

    const tr = byId("m_tr"); const trWrap = byId("m_togTr");
    trWrap.addEventListener("click", (e)=>{ if(e.target.tagName.toLowerCase()==="input") return; tr.checked=!tr.checked; tr.dispatchEvent(new Event("change")); });
    tr.addEventListener("change", ()=>{ m.tr = !!tr.checked; mApplyVisibility(); mRenderOutput(); mSave(); });
  }

  function mApplyVisibility(){
    const appliesWall = (m.obj !== "tank");
    byId("m_wallBlock").style.display = appliesWall ? "block" : "none";
    byId("m_wallNA").style.display = appliesWall ? "none" : "block";

    if(mBindToggles._sync) mBindToggles._sync();

    const antDistRow = byId("m_antDistRow");
    byId("m_antPlace").disabled = !m.ant;
    antDistRow.style.display = (m.ant && (m.antPlace === "out")) ? "grid" : "none";

    const tunnelBlock = byId("m_tunnelBlock");
    tunnelBlock.style.display = (m.obj === "tunnel") ? "block" : "none";
    byId("m_trCount").disabled = !(m.obj==="tunnel" && m.tr);
    byId("m_trDist").disabled = !(m.obj==="tunnel" && m.tr);
    if(m.obj !== "tunnel"){
      m.tr = false; m.trCount = 0; m.trDist = 0;
      byId("m_tr").checked = false;
    }
  }

  function mFillInputs(){
    byId("m_sensors").value = m.sensors ?? 0; byId("m_heat").checked = !!m.heat;
    byId("m_len").value = m.len ?? 0; byId("m_diam").value = m.diam ?? 0;
    byId("m_elbows").value = m.elbows ?? 0; byId("m_connElbows").value = m.connElbows ?? 0;
    byId("m_tees").value = m.tees ?? 0; byId("m_connTees").value = m.connTees ?? 0;
    byId("m_crosses").value = m.crosses ?? 0; byId("m_connCrosses").value = m.connCrosses ?? 0;
    byId("m_servers").value = m.servers ?? 0; byId("m_distLast").value = m.distLast ?? 0;
    byId("m_psuCount").value = m.psuCount ?? 0; byId("m_psuPower").value = m.psuPower ?? 0;
    byId("m_distConn").value = m.distConn ?? 0; byId("m_custNet").value = m.custNet ? "1" : "0";
    byId("m_ant").checked = !!m.ant; byId("m_antPlace").value = m.antPlace || "in"; byId("m_antDist").value = m.antDist ?? 0;
    byId("m_tr").checked = !!m.tr; byId("m_trCount").value = m.trCount ?? 0; byId("m_trDist").value = m.trDist ?? 0;
  }

  function mOutRows(){
    const objName = ({building:"Здание", tank:"Резервуар", tunnel:"Тоннель", special:"Спец. назначение"})[m.obj] || m.obj;
    const wallName = ({anchor:"Обычный анкер", chem:"Химический анкер"})[m.wall] || m.wall;
    const rows = [];
    rows.push({pos:"Тип объекта", unit:"—", qty: objName, note:""});
    if(m.obj !== "tank") rows.push({pos:"Крепление к стене", unit:"—", qty: wallName, note:""});
    rows.push({pos:"Гофра", unit:"—", qty: m.obj==="tank" ? "Да (по умолчанию)" : (m.gofra ? "Да" : "Нет"), note:""});
    if(m.obj !== "tank") rows.push({pos:"Взрывозащита", unit:"—", qty: m.ex ? "Да" : "Нет", note:""});
    rows.push({pos:"Вибрация", unit:"—", qty: m.vib ? "Да" : "Нет", note: m.vib ? "→ поплавки (по Excel)" : ""});

    rows.push({pos:"Датчики", unit:"шт", qty: Number(m.sensors||0), note: m.heat ? "обогрев: да" : "обогрев: нет"});
    rows.push({pos:"Трасса (длина)", unit:"м", qty: Number(m.len||0), note: (m.diam?`Ø ${m.diam} мм`:"")});

    rows.push({pos:"Углы", unit:"шт", qty: Number(m.elbows||0), note:""});
    if(Number(m.connElbows||0)>0) rows.push({pos:"Соединители для углов", unit:"шт", qty:Number(m.connElbows||0), note:"вручную"});

    rows.push({pos:"Тройники", unit:"шт", qty: Number(m.tees||0), note:""});
    if(Number(m.connTees||0)>0) rows.push({pos:"Соединители для тройников", unit:"шт", qty:Number(m.connTees||0), note:"вручную"});

    rows.push({pos:"Четверники", unit:"шт", qty: Number(m.crosses||0), note:""});
    if(Number(m.connCrosses||0)>0) rows.push({pos:"Соединители для четверников", unit:"шт", qty:Number(m.connCrosses||0), note:"вручную"});

    rows.push({pos:"Серверы", unit:"шт", qty: Number(m.servers||0), note:""});
    rows.push({pos:"Блоки питания", unit:"шт", qty: Number(m.psuCount||0), note: m.psuPower?`${m.psuPower} Вт/шт`:""});

    rows.push({pos:"Датчик → сервер (крайний)", unit:"м", qty: Number(m.distLast||0), note:""});
    rows.push({pos:"Сервер → точка подключения", unit:"м", qty: Number(m.distConn||0), note:""});

    rows.push({pos:"Интернет заказчика", unit:"—", qty: m.custNet ? "Да" : "Нет", note:""});
    rows.push({pos:"Интернет-антенна", unit:"—", qty: m.ant ? "Да" : "Нет", note: m.ant ? (m.antPlace==="out" ? "выносная" : "в сервере") : ""});
    if(m.ant && m.antPlace==="out") rows.push({pos:"Сервер → антенна", unit:"м", qty: Number(m.antDist||0), note:"выносная"});

    if(m.obj==="tunnel"){
      rows.push({pos:"Трансформатор", unit:"—", qty: m.tr ? "Да" : "Нет", note:"только тоннель"});
      if(m.tr){
        rows.push({pos:"Трансформаторы", unit:"шт", qty:Number(m.trCount||0), note:""});
        rows.push({pos:"Трансформатор → сервер", unit:"м", qty:Number(m.trDist||0), note:""});
      }
    }

    const notes = [];
    if(m.obj==="tank") notes.push("резервуар: гофра по умолчанию");
    if(m.vib) notes.push("вибрация: добавить поплавки (по Excel)");
    if(m.heat) notes.push("обогрев: выше потребление");
    return { rows, notes };
  }

  function mRenderOutput(){
    const out = mOutRows();
    const tbl = byId("m_outTable");
    tbl.innerHTML =
      `<thead><tr><th>Позиция</th><th>Ед.</th><th>Кол-во</th><th>Комментарий</th></tr></thead>` +
      `<tbody>` + out.rows.map(r => `
        <tr>
          <td><b>${String(r.pos)}</b></td>
          <td>${String(r.unit)}</td>
          <td class="mono">${String(r.qty)}</td>
          <td>${String(r.note||"")}</td>
        </tr>`).join("") + `</tbody>`;
    byId("m_status").textContent = out.notes.length ? ("Примечания: " + out.notes.join(" • ")) : "Примечаний нет.";
  }

  async function mCopy(){
    const out = mOutRows();
    const lines = out.rows.map(r => `- ${r.pos}: ${r.qty} ${r.unit}${r.note ? " ("+r.note+")" : ""}`);
    const text = `Монтажные комплектующие — параметры\n${lines.join("\n")}`;
    try{ await navigator.clipboard.writeText(text); showToast("Итог скопирован"); }
    catch(e){ showToast("Не удалось скопировать"); }
  }
  function mReset(){ localStorage.removeItem(MKEY); location.reload(); }

  function mInit(){
    mLoad();
    if(m.obj === "tank") m.gofra = true;

    mRenderStepper();
    mRenderObjTiles();
    mRenderWallTiles();
    mBindToggles();
    mBindNums();
    mFillInputs();
    mApplyVisibility();
    mRenderOutput();
    mGo(Number(m.step||0));

    byId("m_next0").addEventListener("click", () => mGo(1));
    byId("m_prev1").addEventListener("click", () => mGo(0));
    byId("m_next1").addEventListener("click", () => mGo(2));
    byId("m_prev2").addEventListener("click", () => mGo(1));
    byId("m_next2").addEventListener("click", () => mGo(3));
    byId("m_prev3").addEventListener("click", () => mGo(2));
    byId("m_next3").addEventListener("click", () => mGo(4));
    byId("m_prev4").addEventListener("click", () => mGo(3));
    byId("m_next4").addEventListener("click", () => mGo(5));
    byId("m_prev5").addEventListener("click", () => mGo(4));

    byId("m_copy").addEventListener("click", mCopy);
    byId("m_reset").addEventListener("click", mReset);
  }
  mInit();
})();
</script>
</body>
</html>
